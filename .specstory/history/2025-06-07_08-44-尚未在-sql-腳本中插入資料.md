<!-- Generated by SpecStory -->

# 尚未在 SQL 腳本中插入資料 (2025-06-07 16:44:24)

_**User**_

現在只差在 @om_extract.sql 這邊段還是沒有insert資料進去

---

_**Assistant**_



---

好的，我了解您的問題。`om_extract.sql` 這個腳本沒有新增任何資料到 `ZEN_B2B_JSON_SO_TMP`，這通常表示 `INSERT` 陳述式中的 `SELECT` 查詢沒有返回任何資料列。

這個 `SELECT` 查詢的 `WHERE` 條件相當複雜，有很多過濾條件，其中任何一個都可能導致撈取不到資料。我分析了幾個最有可能的原因：

1.  **與 WMS 系統的關聯**: `O.invoice_no = WS.INVOICENO` 這個條件將查詢結果與 `zenwms.WMS_SHIPPING@hr WS` 這個遠端資料表進行關聯。這意味著只有在飛力達(Feliks)的WMS系統 (`@hr` dblink) 中的 `WMS_SHIPPING` 資料表裡有對應的發票號碼時，資料才會被選取。這是一個很強的相依性，如果 `WMS_SHIPPING` 資料表沒有即時更新，或者發票號碼不匹配，就不會有任何資料。

2.  **日期範圍過濾**: `TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC(sysdate) - 1 AND TRUNC(sysdate) + 1` 這個條件把預計出貨日 (`EXP_SHIP_DATE`) 限制在昨天、今天和明天。如果這段期間內沒有符合所有其他條件的出貨單，查詢就會是空的。

3.  **特定的庫存地點**: `zs.FROM_SUBINVENTORY_CODE = '外存倉'` 以及 `(mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')` 這兩個條件要求貨品必須是從「外存倉」這個子庫存，並且儲位包含「飛力達」的資料才會被選取，這也可能過濾掉所有資料。

4.  **`NOT EXISTS` 檢查**: 這個子查詢會排除掉 `ZEN_B2B_JSON_SO` 中已經存在且狀態為 'W', 'N' 或 'S' 的資料。如果所有符合條件的資料都已經被處理過，那就不會再新增。

為了找出問題點，我建議可以先從最可疑的地方開始測試。我們可以暫時拿掉與 `WMS_SHIPPING` 的關聯，看看是否能查到資料。如果這樣可以，那就表示問題出在 `WMS_SHIPPING` 的資料同步上。

我將對 `src/main/resources/sql/om_extract.sql` 提出修改建議，請您試試看。我會將 `zenwms.WMS_SHIPPING@hr WS` 資料表及其關聯條件註解掉。

如果這個修改後仍然沒有資料，下一步我們可以嘗試放寬或暫時移除日期的過濾條件來測試。

```sql:src/main/resources/sql/om_extract.sql
// ... existing code ...
                 a.INVOICE_NO,
                 a.INVOICE_DATE,
                 a.CUSTOMER_ID
            FROM apps.ZEN_PACKING_INVOICE_HEADER@zenprod A,
                 apps.ZEN_PACKING_INVOICE_LINE@zenprod B
           WHERE a.invoice_id = b.invoice_id AND b.INVOICE_SOURCE = 'DELIVERY') O
--         , zenwms.WMS_SHIPPING@hr WS
   WHERE     d.DELIVERY_ID >= 2124472
         AND d.delivery_id = wda.delivery_id
         AND wda.delivery_detail_id = wdd.delivery_detail_id
// ... existing code ...
         AND ship_ps.location_id = ship_loc.location_id
         AND d.DELIVERY_ID = O.DELIVERY_ID
         AND D.name = O.DELIVERY_NAME
         AND mtls.organization_id = d.organization_id    
         --AND O.invoice_no = WS.INVOICENO
         AND zs.FROM_SUBINVENTORY_CODE = '外存倉'
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
// ... existing code ...
```

---

_**User**_

但是我去SQL Developer下是有92筆資料的

---

_**Assistant**_



---

您好，感謝您的回覆。您在 SQL Developer 中可以查到 92 筆資料，這是一個非常有用的資訊，代表 SQL 語法本身的邏輯是正確的。

這種情況通常表示，您的應用程式執行 SQL 的環境，和您手動在 SQL Developer 執行的環境之間存在差異。

最有可能的差異點是 `NOT EXISTS` 這個條件：
```sql
AND NOT EXISTS(
   SELECT 1
   FROM ZEN_B2B_JSON_SO 
   WHERE 
         ID = O.invoice_no || '-' || l.line_id 
         AND (STATUS = 
         (CASE 
            ...
            END) OR STATUS = 'S')
)
```
這個條件會過濾掉 `ZEN_B2B_JSON_SO` 中已經存在的紀錄。很有可能在應用程式連線的資料庫中，這 92 筆資料已經存在於 `ZEN_B2B_JSON_SO` 表格內，所以查詢結果為 0。但在您 SQL Developer 的連線環境中，這些資料不存在，所以查得到。

這可能是因為：
1.  您在 SQL Developer 和應用程式連線到的是不同的資料庫實例 (例如開發資料庫 vs. 生產資料庫)。
2.  雖然是同一個資料庫，但之前的測試或執行已經把資料寫入 `ZEN_B2B_JSON_SO` 了。

為了驗證這一點，我建議您可以暫時將 `NOT EXISTS` 條件移除，然後透過應用程式執行看看。如果這樣可以抓到資料，那就證實問題出在 `ZEN_B2B_JSON_SO` 的資料上。

我將提供修改後的 `om_extract.sql`，暫時將 `NOT EXISTS` 區塊註解掉，請您試試看：

```sql:src/main/resources/sql/om_extract.sql
// ... existing code ...
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
         AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC(sysdate) - 1 AND TRUNC(sysdate) + 1 --for正式上線一週後(自動化)
         /* -- Temporarily disabled for debugging
         AND NOT EXISTS(
            SELECT 1
            FROM ZEN_B2B_JSON_SO 
            WHERE 
                  ID = O.invoice_no || '-' || l.line_id 
                  AND (STATUS = 
                  (CASE 
                        WHEN d.name IS NULL -- ORDER_NO
                        OR O.invoice_no IS NULL -- INVOICE_NO
                        OR O.invoice_date IS NULL -- INVOICE_DATE
                        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
                        OR (SELECT ffvt.description
                              FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                              jtf_rs_salesreps@zenprod jrs,
                              gl_code_combinations@zenprod gcc,
                              fnd_id_flex_segments@zenprod fifs,
                              fnd_flex_values@zenprod ffv,
                              fnd_flex_values_tl@zenprod ffvt
                        WHERE     rsua.site_use_code = 'SHIP_TO'
                              AND rsua.site_use_id = ship_su.site_use_id
                              AND jrs.salesrep_id = rsua.primary_salesrep_id
                              AND gcc.code_combination_id = jrs.gl_id_rev
                              AND fifs.id_flex_num = gcc.chart_of_accounts_id
                              AND fifs.segment_name = '部門別'
                              AND ffv.flex_value_set_id = fifs.flex_value_set_id
                              AND ffv.flex_value = gcc.segment2
                              AND ffvt.flex_value_id = ffv.flex_value_id
                              AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
                        OR party.party_name IS NULL -- CUST_NAME
                        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
                        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
                        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
                        OR mtls.segment1
                        || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
                        || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
                        OR (SELECT mcb.segment1
                              FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
                        WHERE     mic.category_set_id = 1
                              AND mic.category_id = mcb.category_id
                              AND mic.organization_id = mtls.organization_id
                              AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
                        OR  DECODE (mtls.segment1,
                              '銷貨折讓', wdd.requested_quantity * -1,
                              wdd.requested_quantity) IS NULL -- QUANTITY
                        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
                        OR DECODE (mtls.segment1,
                                    '銷貨折讓', wdd.requested_quantity * -1,
                                    wdd.requested_quantity)
                        * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
                        OR mtls.attribute1 IS NULL -- ITEM_MODE
                        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
                        OR mil.segment1 IS NULL -- SEGMENT1 
                        OR mil.segment2 IS NULL -- SEGMENT2
                        THEN 'N'
                        ELSE 'W'
                        END) OR STATUS = 'S')
         )
         */
ORDER BY ORDER_NO, ID
);
end;
```

請您使用這個版本的 SQL 透過應用程式執行一次。如果這樣能夠成功新增資料，我們就能確認問題點，然後再討論下一步該如何處理 `ZEN_B2B_JSON_SO` 裡的舊資料。

---

_**User**_

我確定連到同一個資料庫，我剛去SQL Developer下有92筆

---

_**Assistant**_



---

了解，感謝您的再次確認。

您在同一個資料庫上，使用 SQL Developer 查詢可以得到 92 筆資料，但是透過應用程式執行卻沒有新增任何資料，這幾乎可以完全肯定是 `NOT EXISTS` 這個子查詢造成的。

它的運作原理是：
1.  主查詢找到了 92 筆符合條件的訂單資料。
2.  對於這 92 筆資料的每一筆，`NOT EXISTS` 子查詢都會去 `ZEN_B2B_JSON_SO` 資料表中檢查，看看是否有相同 `ID` (`O.invoice_no || '-' || l.line_id`) 的紀錄已經存在。
3.  如果紀錄已經存在，`NOT EXISTS` 就會把這筆資料從主查詢的結果中排除。
4.  您遇到的情況是，這 92 筆資料很可能都已經存在於 `ZEN_B2B_JSON_SO` 中了 (也許是之前的測試留下的)，所以它們全被排除了，最終導致 `INSERT` 的來源是 0 筆資料。

為了驗證這個推論，我建議您暫時將 `NOT EXISTS` 區塊註解掉再執行一次。如果這樣能成功新增資料，我們就能 100% 確定問題點。

請您套用以下的程式碼修改，我將 `NOT EXISTS` 的部分註解掉：

```sql:src/main/resources/sql/om_extract.sql
// ... existing code ...
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
         AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC(sysdate) - 1 AND TRUNC(sysdate) + 1 --for正式上線一週後(自動化)
         /* -- Temporarily disabled for debugging
         AND NOT EXISTS(
            SELECT 1
            FROM ZEN_B2B_JSON_SO 
            WHERE 
                  ID = O.invoice_no || '-' || l.line_id 
                  AND (STATUS = 
                  (CASE 
                        WHEN d.name IS NULL -- ORDER_NO
                        OR O.invoice_no IS NULL -- INVOICE_NO
                        OR O.invoice_date IS NULL -- INVOICE_DATE
                        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
                        OR (SELECT ffvt.description
                              FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                              jtf_rs_salesreps@zenprod jrs,
                              gl_code_combinations@zenprod gcc,
                              fnd_id_flex_segments@zenprod fifs,
                              fnd_flex_values@zenprod ffv,
                              fnd_flex_values_tl@zenprod ffvt
                        WHERE     rsua.site_use_code = 'SHIP_TO'
                              AND rsua.site_use_id = ship_su.site_use_id
                              AND jrs.salesrep_id = rsua.primary_salesrep_id
                              AND gcc.code_combination_id = jrs.gl_id_rev
                              AND fifs.id_flex_num = gcc.chart_of_accounts_id
                              AND fifs.segment_name = '部門別'
                              AND ffv.flex_value_set_id = fifs.flex_value_set_id
                              AND ffv.flex_value = gcc.segment2
                              AND ffvt.flex_value_id = ffv.flex_value_id
                              AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
                        OR party.party_name IS NULL -- CUST_NAME
                        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
                        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
                        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
                        OR mtls.segment1
                        || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
                        || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
                        OR (SELECT mcb.segment1
                              FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
                        WHERE     mic.category_set_id = 1
                              AND mic.category_id = mcb.category_id
                              AND mic.organization_id = mtls.organization_id
                              AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
                        OR  DECODE (mtls.segment1,
                              '銷貨折讓', wdd.requested_quantity * -1,
                              wdd.requested_quantity) IS NULL -- QUANTITY
                        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
                        OR DECODE (mtls.segment1,
                                    '銷貨折讓', wdd.requested_quantity * -1,
                                    wdd.requested_quantity)
                        * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
                        OR mtls.attribute1 IS NULL -- ITEM_MODE
                        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
                        OR mil.segment1 IS NULL -- SEGMENT1 
                        OR mil.segment2 IS NULL -- SEGMENT2
                        THEN 'N'
                        ELSE 'W'
                        END) OR STATUS = 'S')
         )
         */
ORDER BY ORDER_NO, ID
);
end;
```

請您執行看看結果如何。

---

_**User**_

如果 ZEN_B2B_JSON_SO資料真的已經有了，為甚麼 SQL Developer 查詢可以得到 92 筆資料?

---

_**Assistant**_



---

這是一個非常好的問題，點出了資料庫運作的一個關鍵細節。您說的沒錯，如果 `ZEN_B2B_JSON_SO` 真的已經有資料，理論上您在 SQL Developer 執行相同的查詢，結果應該也是 0 筆。

這種「在 SQL Developer 查得到，在應用程式查不到」的情境，最常見的原因是 **您在 SQL Developer 中執行的查詢，和腳本中完整的查詢，其實並不完全一樣。**

我推測您在 SQL Developer 中可能是執行了主要的 `SELECT` 部分，也就是這個區塊：

```sql
-- 您可能在 SQL Developer 執行了這個部分
SELECT 'ZEN' as SENDER_CODE, ...
FROM apps.wsh_new_deliveries@zenprod d, ...
WHERE d.DELIVERY_ID >= 2124472 ...
AND TO_DATE(...) BETWEEN ... 
```
這個部分的查詢，它的確可以撈到 92 筆原始的訂單資料。

但是，在 `om_extract.sql` 腳本中，完整的查詢其實還包含了最後的 `NOT EXISTS` 過濾條件：

```sql
-- 完整的查詢還包含了這一段
AND NOT EXISTS (
    SELECT 1
    FROM ZEN_B2B_JSON_SO 
    WHERE ID = O.invoice_no || '-' || l.line_id
    AND (STATUS = ... OR STATUS = 'S')
)
```

`NOT EXISTS` 的作用就像一個守門員。它的意思是：**「只有當這筆資料的 ID 從未存在於 `ZEN_B2B_JSON_SO` 表格中時，才把它選出來。」**

所以，整個流程是：
1.  主查詢找到了 92 筆符合條件的出貨單。
2.  接著，對於這 92 筆資料的每一筆，`NOT EXISTS` 子查詢都會去 `ZEN_B2B_JSON_SO` 裡面檢查。
3.  它發現這 92 筆資料的 ID 都已經存在於 `ZEN_B2B_JSON_SO` 表格中了（可能是上次執行或測試時留下的）。
4.  因此，`NOT EXISTS` 條件不成立，這 92 筆資料全都被過濾掉了。
5.  最終，傳給 `INSERT` 陳述式的資料就變成了 0 筆。

**為了驗證這一點，您可以再做個簡單的測試：**

請在 SQL Developer 中，**完整地**複製並執行 `om_extract.sql` 裡面 `from (...)` 到 `ORDER BY ...` 的整個 `SELECT` 陳述式，**確保包含了 `NOT EXISTS` 子查詢**。我預期這個查詢在 SQL Developer 中跑出來的結果也會是 0 筆，這就能證明問題的確是出在 `ZEN_B2B_JSON_SO` 裡面已經有資料了。

如果確認是這個原因，那麼解決方案就是：
1.  如果您是在測試環境，可以先手動 `DELETE FROM ZEN_B2B_JSON_SO;` 和 `DELETE FROM ZEN_B2B_JSON_SO_TMP;` 來清空測試資料。
2.  將 `om_extract.sql` 恢復到原始版本（也就是把 `NOT EXISTS` 加回來），這樣才能確保不會重複處理相同的資料。

我先把 `om_extract.sql` 恢復到原始狀態，因為這個檢查邏輯對於正式運作是必要的。

```sql:src/main/resources/sql/om_extract.sql
// ... existing code ...
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
         AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC(sysdate) - 1 AND TRUNC(sysdate) + 1 --for正式上線一週後(自動化)
         AND NOT EXISTS(
            SELECT 1
            FROM ZEN_B2B_JSON_SO 
            WHERE 
                  ID = O.invoice_no || '-' || l.line_id 
                  AND (STATUS = 
                  (CASE 
                        WHEN d.name IS NULL -- ORDER_NO
                        OR O.invoice_no IS NULL -- INVOICE_NO
                        OR O.invoice_date IS NULL -- INVOICE_DATE
                        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
                        OR (SELECT ffvt.description
                              FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                              jtf_rs_salesreps@zenprod jrs,
                              gl_code_combinations@zenprod gcc,
                              fnd_id_flex_segments@zenprod fifs,
                              fnd_flex_values@zenprod ffv,
                              fnd_flex_values_tl@zenprod ffvt
                        WHERE     rsua.site_use_code = 'SHIP_TO'
                              AND rsua.site_use_id = ship_su.site_use_id
                              AND jrs.salesrep_id = rsua.primary_salesrep_id
                              AND gcc.code_combination_id = jrs.gl_id_rev
                              AND fifs.id_flex_num = gcc.chart_of_accounts_id
                              AND fifs.segment_name = '部門別'
                              AND ffv.flex_value_set_id = fifs.flex_value_set_id
                              AND ffv.flex_value = gcc.segment2
                              AND ffvt.flex_value_id = ffv.flex_value_id
                              AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
                        OR party.party_name IS NULL -- CUST_NAME
                        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
                        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
                        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
                        OR mtls.segment1
                        || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
                        || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
                        OR (SELECT mcb.segment1
                              FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
                        WHERE     mic.category_set_id = 1
                              AND mic.category_id = mcb.category_id
                              AND mic.organization_id = mtls.organization_id
                              AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
                        OR  DECODE (mtls.segment1,
                              '銷貨折讓', wdd.requested_quantity * -1,
                              wdd.requested_quantity) IS NULL -- QUANTITY
                        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
                        OR DECODE (mtls.segment1,
                                    '銷貨折讓', wdd.requested_quantity * -1,
                                    wdd.requested_quantity)
                        * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
                        OR mtls.attribute1 IS NULL -- ITEM_MODE
                        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
                        OR mil.segment1 IS NULL -- SEGMENT1 
                        OR mil.segment2 IS NULL -- SEGMENT2
                        THEN 'N'
                        ELSE 'W'
                        END) OR STATUS = 'S')
         )
ORDER BY ORDER_NO, ID
);
end;  
```

---

_**User**_

我在SQL Developer執行的是以下這段:
SELECT 
     'ZEN' as SENDER_CODE,
     'FEILIKS' as RECEIVER_CODE,
      CASE 
        WHEN d.name IS NULL -- ORDER_NO
        OR O.invoice_no IS NULL -- INVOICE_NO
        OR O.invoice_date IS NULL -- INVOICE_DATE
        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
        OR (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ffvt
           WHERE     rsua.site_use_code = 'SHIP_TO'
                 AND rsua.site_use_id = ship_su.site_use_id
                 AND jrs.salesrep_id = rsua.primary_salesrep_id
                 AND gcc.code_combination_id = jrs.gl_id_rev
                 AND fifs.id_flex_num = gcc.chart_of_accounts_id
                 AND fifs.segment_name = '部門別'
                 AND ffv.flex_value_set_id = fifs.flex_value_set_id
                 AND ffv.flex_value = gcc.segment2
                 AND ffvt.flex_value_id = ffv.flex_value_id
                 AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
        OR party.party_name IS NULL -- CUST_NAME
        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
        OR mtls.segment1
         || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
         || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
        OR (SELECT mcb.segment1
            FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
           WHERE     mic.category_set_id = 1
                 AND mic.category_id = mcb.category_id
                 AND mic.organization_id = mtls.organization_id
                 AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
        OR  DECODE (mtls.segment1,
                 '銷貨折讓', wdd.requested_quantity * -1,
                 wdd.requested_quantity) IS NULL -- QUANTITY
        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
        OR DECODE (mtls.segment1,
                   '銷貨折讓', wdd.requested_quantity * -1,
                   wdd.requested_quantity)
         * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
        OR mtls.attribute1 IS NULL -- ITEM_MODE
        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
        OR mil.segment1 IS NULL -- SEGMENT1 
        OR mil.segment2 IS NULL -- SEGMENT2
        THEN 'N'
        ELSE 'W'
      END as STATUS,
     'OUT' as DIRECTION,
     TO_CHAR(O.invoice_date, 'yyyy-MM-dd HH:mm:ss') as DOC_DATETIME,
     TO_CHAR(sysdate, 'yyyy-MM-dd HH:mm:ss') as LAST_UPDATE_DATE,
     TO_CHAR(sysdate, 'yyyy-MM-dd HH:mm:ss') as CREATION_DATE,
     'admin' as USER_NO,
     O.invoice_no || '-' || l.line_id as ID,
     d.name as ORDER_NO,
     d.ATTRIBUTE5 as INV_SPLIT,
     O.invoice_no as INVOICE_NO,
     TO_CHAR(TRUNC(O.invoice_date), 'yyyy/mm/dd') as INVOICE_DATE,
     TO_CHAR(TO_DATE(d.attribute12, 'DD-MON-YYYY', 'NLS_DATE_LANGUAGE=AMERICAN'), 'yyyy/mm/dd') as EXP_SHIP_DATE,
     cust_acct.account_number as CUST_NO,
      (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ffvt
           WHERE     rsua.site_use_code = 'SHIP_TO'
                 AND rsua.site_use_id = ship_su.site_use_id
                 AND jrs.salesrep_id = rsua.primary_salesrep_id
                 AND gcc.code_combination_id = jrs.gl_id_rev
                 AND fifs.id_flex_num = gcc.chart_of_accounts_id
                 AND fifs.segment_name = '部門別'
                 AND ffv.flex_value_set_id = fifs.flex_value_set_id
                 AND ffv.flex_value = gcc.segment2
                 AND ffvt.flex_value_id = ffv.flex_value_id
                 AND fifs.id_flex_code = 'GL#')
            as DEPT,
      party.party_name as CUST_NAME,
      bill_loc.address1 as INVOICE_ADDRESS,
      ship_ps.party_site_number as SHIP_TO_NO,
      NVL (d.attribute8, ship_loc.address1) as DELIVERY_ADDRESS,
      (SELECT first_name || last_name
            FROM ZEN_RA_CONTACTS_V@zenprod rcs
           WHERE     rcs.customer_id = l.sold_to_org_id
                 AND rcs.address_id = ship_cas.cust_acct_site_id
                 AND rcs.contact_id =
                        (SELECT MIN (contact_id)
                           FROM ZEN_RA_CONTACTS_V@zenprod rcs
                          WHERE     rcs.customer_id = l.sold_to_org_id
                                AND rcs.address_id = ship_cas.cust_acct_site_id
                                AND rcs.status = 'A'))
            as SHIP_TO_CONTACT,
      (SELECT DECODE (a.phone_area_code,
                         NULL, a.phone_number,
                         a.phone_area_code || '-' || a.phone_number)
            FROM zen_ra_phones_v@zenprod a
           WHERE     a.phone_id =
                        (  SELECT MAX (b.phone_id)
                             FROM zen_ra_phones_v@zenprod b
                            WHERE     a.customer_id = b.customer_id
                                  AND a.address_id = b.address_id
                                  AND b.phone_line_type = 'GEN'
                         GROUP BY b.customer_id, b.address_id)
                 AND a.phone_line_type = 'GEN'
                 AND a.customer_id = l.sold_to_org_id
                 AND a.address_id = ship_cas.cust_acct_site_id)
            as SHIP_TO_PHONE,
      mtls.segment1
         || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
         || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL)
            as ZT_PART_NO,
      NVL (l.attribute3, l.attribute5) as CUST_PART_NO,
      l.attribute2 || DECODE (l.attribute1, NULL, NULL, '-' || l.attribute1)
            as CUSTOMER_PO,
      (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute1)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute2)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute3)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute4)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute5)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute6)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute7)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute8)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute9)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute10)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute11)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute14)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute15)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute16)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute17)
         || ' '
         || CASE
               WHEN (NVL (d.ATTRIBUTE6, ship_su.ATTRIBUTE22)) IS NOT NULL
               THEN
                     'Shipping Mark:'
                  || NVL (d.ATTRIBUTE6, ship_su.ATTRIBUTE22)
                  || ' '
               ELSE
                  ' '
            END
         || ship_cas.attribute12
            as SHIP_NOTICE,
      d.attribute4 as SHIP_NOTES,
      DECODE (wdd.RELEASED_STATUS,
                 'B', 'BK',
                 'C', 'SH',
                 'D', 'CL',
                 'R', 'RR',
                 'S', 'RW',
                 'Y', 'SG',
                 'N', 'NR',
                 'X', 'NA')
            as STATUS1,
      (SELECT mcb.segment1
            FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
           WHERE     mic.category_set_id = 1
                 AND mic.category_id = mcb.category_id
                 AND mic.organization_id = mtls.organization_id
                 AND mic.inventory_item_id = mtls.inventory_item_id)
            as BRAND,
      DECODE (mtls.segment1,
                 '銷貨折讓', wdd.requested_quantity * -1,
                 wdd.requested_quantity)
            as QUANTITY,
      TO_CHAR(l.UNIT_SELLING_PRICE,'FM9999999999999990.99999999999999999999') as UNIT_PRICE,
      DECODE (mtls.segment1,
                   '銷貨折讓', wdd.requested_quantity * -1,
                   wdd.requested_quantity)
         * l.UNIT_SELLING_PRICE
            as AMOUNT,
      l.ATTRIBUTE2 as CUST_PO,
      l.attribute6 as CUST_PO2,
      l.ATTRIBUTE1 as CUST_POLINE,
      l.ATTRIBUTE3 as CUST_PN,
      l.ATTRIBUTE5 as CUST_PN2,
      MCI.CUSTOMER_ITEM_DESC as ITEM_DESC,
      mtls.attribute1 as ITEM_MODE,
      l.attribute8 as ORDER_LINE_MEMO,
      TO_CHAR(mtls.UNIT_WEIGHT,'FM9999999999999990.99999999999999999999') as UNIT_WEIGHT,
      mtls.WEIGHT_UOM_CODE as WEIGHT_UOM_CODE,
      zs.FROM_SUBINVENTORY_CODE as FROM_SUBINVENTORY_CODE,
      mil.segment1 as SEGMENT1,
      mil.segment2 as SEGMENT2,
      '撿貨單' as KIND,
      CASE
            WHEN (SELECT msi.attribute9
                    FROM mtl_system_items@zenprod msi
                   WHERE     msi.organization_id = 3
                         AND msi.inventory_item_id = mtls.inventory_item_id)
                    IS NOT NULL
            THEN
               (SELECT msi.attribute9
                  FROM mtl_system_items@zenprod msi
                 WHERE     msi.organization_id = 3
                       AND msi.inventory_item_id = mtls.inventory_item_id)
            ELSE
               mtls.attribute9
         END
            as SUPPLIER_PARTNO,
      MCI.ATTRIBUTE1 as INV_AND_PAC,
      MCI.ATTRIBUTE2 as CUST_PART_NO2,
      h.ATTRIBUTE3 as PO_REMARK,
      '' as RMA_NUMBER,
      '0' as ORD_TYPE,
      'TY' as QC_TYPE 
    FROM apps.wsh_new_deliveries@zenprod d,
         apps.wsh_delivery_assignments@zenprod wda,
         apps.wsh_delivery_details@zenprod wdd,
         apps.mtl_system_items_b@zenprod mtls,
         apps.mtl_item_locations@zenprod mil,
         apps.oe_order_headers_all@zenprod h,
         apps.oe_order_lines_all@zenprod l,
         apps.ZEN_WSH_PICK_SLIP_V@zenprod zs,
         apps.hz_cust_accounts@zenprod cust_acct,
         apps.hz_parties@zenprod party,
         apps.hz_locations@zenprod bill_loc,
         apps.hz_party_sites@zenprod bill_ps,
         apps.hz_cust_acct_sites_all@zenprod bill_cas,
         apps.hz_cust_site_uses_all@zenprod bill_su,
         apps.hz_locations@zenprod ship_loc,
         apps.hz_party_sites@zenprod ship_ps,
         apps.hz_cust_acct_sites_all@zenprod ship_cas,
         apps.hz_cust_site_uses_all@zenprod ship_su,
         apps.MTL_CUSTOMER_ITEMS@zenprod MCI,
         (SELECT a.organization_id,
                 b.DELIVERY_ID,
                 b.DELIVERY_NAME,
                 a.INVOICE_NO,
                 a.INVOICE_DATE,
                 a.CUSTOMER_ID
            FROM apps.ZEN_PACKING_INVOICE_HEADER@zenprod A,
                 apps.ZEN_PACKING_INVOICE_LINE@zenprod B
           WHERE a.invoice_id = b.invoice_id AND b.INVOICE_SOURCE = 'DELIVERY') O,
         zenwms.WMS_SHIPPING@hr WS
   WHERE     d.DELIVERY_ID >= 2124472
         AND d.delivery_id = wda.delivery_id
         AND wda.delivery_detail_id = wdd.delivery_detail_id
         AND mil.organization_id(+) = zs.organization_id
         AND mil.subinventory_code(+) = zs.FROM_SUBINVENTORY_CODE
         AND mil.inventory_location_id(+) = zs.from_LOCATOR_ID
         AND wdd.inventory_item_id = mtls.inventory_item_id
         AND wdd.source_header_id = h.header_id
         AND wdd.source_line_id = l.line_id
         AND zs.move_order_line_id = wdd.move_order_line_id
         AND zs.ORGANIZATION_ID = wdd.ORGANIZATION_ID
         AND l.sold_to_org_id = MCI.customer_id(+)
         AND l.attribute3 = MCI.customer_item_number(+)
         AND l.sold_to_org_id = cust_acct.cust_account_id
         AND cust_acct.party_id = party.party_id
         AND bill_cas.party_site_id = bill_ps.party_site_id
         AND bill_ps.location_id = bill_loc.location_id
         AND bill_su.cust_acct_site_id = bill_cas.cust_acct_site_id
         AND l.invoice_to_org_id = bill_su.site_use_id
         AND l.ship_to_org_id = ship_su.site_use_id
         AND ship_su.cust_acct_site_id = ship_cas.cust_acct_site_id
         AND ship_cas.party_site_id = ship_ps.party_site_id
         AND ship_ps.location_id = ship_loc.location_id
         AND d.DELIVERY_ID = O.DELIVERY_ID
         AND D.name = O.DELIVERY_NAME
         AND mtls.organization_id = d.organization_id    
         AND O.invoice_no = WS.INVOICENO
         AND zs.FROM_SUBINVENTORY_CODE = '外存倉'
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
         AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC(sysdate) - 1 AND TRUNC(sysdate) + 1 --for正式上線一週後(自動化)
         AND NOT EXISTS(
            SELECT 1
            FROM ZEN_B2B_JSON_SO 
            WHERE 
                  ID = O.invoice_no || '-' || l.line_id 
                  AND (STATUS = 
                  (CASE 
                        WHEN d.name IS NULL -- ORDER_NO
                        OR O.invoice_no IS NULL -- INVOICE_NO
                        OR O.invoice_date IS NULL -- INVOICE_DATE
                        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
                        OR (SELECT ffvt.description
                              FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                              jtf_rs_salesreps@zenprod jrs,
                              gl_code_combinations@zenprod gcc,
                              fnd_id_flex_segments@zenprod fifs,
                              fnd_flex_values@zenprod ffv,
                              fnd_flex_values_tl@zenprod ffvt
                        WHERE     rsua.site_use_code = 'SHIP_TO'
                              AND rsua.site_use_id = ship_su.site_use_id
                              AND jrs.salesrep_id = rsua.primary_salesrep_id
                              AND gcc.code_combination_id = jrs.gl_id_rev
                              AND fifs.id_flex_num = gcc.chart_of_accounts_id
                              AND fifs.segment_name = '部門別'
                              AND ffv.flex_value_set_id = fifs.flex_value_set_id
                              AND ffv.flex_value = gcc.segment2
                              AND ffvt.flex_value_id = ffv.flex_value_id
                              AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
                        OR party.party_name IS NULL -- CUST_NAME
                        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
                        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
                        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
                        OR mtls.segment1
                        || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
                        || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
                        OR (SELECT mcb.segment1
                              FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
                        WHERE     mic.category_set_id = 1
                              AND mic.category_id = mcb.category_id
                              AND mic.organization_id = mtls.organization_id
                              AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
                        OR  DECODE (mtls.segment1,
                              '銷貨折讓', wdd.requested_quantity * -1,
                              wdd.requested_quantity) IS NULL -- QUANTITY
                        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
                        OR DECODE (mtls.segment1,
                                    '銷貨折讓', wdd.requested_quantity * -1,
                                    wdd.requested_quantity)
                        * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
                        OR mtls.attribute1 IS NULL -- ITEM_MODE
                        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
                        OR mil.segment1 IS NULL -- SEGMENT1 
                        OR mil.segment2 IS NULL -- SEGMENT2
                        THEN 'N'
                        ELSE 'W'
                        END) OR STATUS = 'S')
         )
ORDER BY ORDER_NO, ID

---

_**Assistant**_



---

好的，感謝您提供這麼詳細的資訊！您貼出的 SQL 語句確實是整個查詢的核心。

您說「在 SQL Developer 執行這段查詢有 92 筆資料」，這是一個關鍵的突破口。我仔細比對了您貼出的查詢和 `om_extract.sql` 檔案中的原始腳本，發現了一個非常微小但極其重要的差異。

在原始的 `om_extract.sql` 檔案中，`SELECT` 陳述式是這樣寫的：

```sql
SELECT /*+ DRIVING_SITE(d) */
'ZEN' as SENDER_CODE,
...
```

而在您貼出的、可以成功查詢到 92 筆資料的版本中，開頭是這樣的：

```sql
SELECT 
'ZEN' as SENDER_CODE,
...
```

您發現了嗎？檔案中的版本多了一個 `/*+ DRIVING_SITE(d) */`。

這不是一個註解，而是一個 Oracle 的提示 (Hint)，它的作用是**強制這個查詢的主要執行地點，從您應用程式所在的資料庫，轉移到 `@zenprod` 這個遠端資料庫上執行**。

這就完全解釋了您遇到的情況：
1.  **您在 SQL Developer 中執行**：您執行的是**沒有** `DRIVING_SITE` 提示的版本。查詢在本地資料庫執行，透過 DBLink 去遠端抓取資料，一切正常，所以回傳 92 筆。
2.  **應用程式執行**：應用程式執行的是**包含** `DRIVING_SITE` 提示的完整腳本。查詢被送到 `@zenprod` 主機上執行。很可能是 `@zenprod` 主機無法順利地反向連回您的本地資料庫 (為了檢查 `NOT EXISTS`)，或是無法從 `@zenprod` 連到 `@hr` (為了JOIN `WMS_SHIPPING` )，導致查詢在那邊執行失敗，回傳 0 筆資料。

這個差異幾乎可以肯定是問題的根源。

為了讓應用程式的執行方式和您在 SQL Developer 中成功的測試保持一致，我建議直接從 `om_extract.sql` 檔案中移除這個提示。這樣查詢就會在本地執行，應該就能正常抓到資料了。

我將為您修改 `src/main/resources/sql/om_extract.sql`：

```sql:src/main/resources/sql/om_extract.sql
// ... existing code ...
insert into ZEN_B2B_JSON_SO_TMP (SEQ_ID,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE) 
select ZEN_B2B_JSON_SEQ.nextval,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE
from (
     SELECT /* DRIVING_SITE(d) */
     'ZEN' as SENDER_CODE,
     'FEILIKS' as RECEIVER_CODE,
      CASE 
// ... existing code ...
```
我把 `/*+ DRIVING_SITE(d) */` 改為 `/* DRIVING_SITE(d) */` (移除了 `+` 號)，這會讓 Oracle 將它視為一般的註解，從而忽略這個提示。請您再試一次看看。

---

_**User**_

還是一樣沒有

---

_**Assistant**_



---

好的，了解了。移除提示後仍然沒有資料，這確實很奇怪，但這種情況通常指向一個更根本的問題。

當同一段 SQL 在 SQL Developer 執行可以成功，但在應用程式中卻失敗時，即便您確認連線到同一個資料庫，問題幾乎總是出在**執行環境的差異**上。

讓我們來分析最有可能造成這種差異的地方：**權限**。

您的應用程式連線資料庫時，很可能是用一個特定的「服務帳號」。而您自己登入 SQL Developer 時，則是用您的個人開發者帳號。這兩個帳號的權限（特別是存取遠端資料庫的權限）很可能不一樣。

您的查詢中，最依賴遠端權限的部分是這一段：
`... , zenwms.WMS_SHIPPING@hr WS`
`... AND O.invoice_no = WS.INVOICENO`

這一段程式碼需要透過 `@hr` 這個 DBLink 去存取 WMS 系統的資料表。這是一個非常常見的出錯點。**很有可能應用程式的「服務帳號」沒有被授予存取 `@hr` DBLink 的權限，或者無法讀取遠端的 `WMS_SHIPPING` 表。** 當查詢執行到這一步時，因為權限不足，它無法取得任何資料，但又沒有明確報錯，最終導致整個查詢結果為 0。

但在您的個人帳號下，權限是足夠的，所以在 SQL Developer 裡執行就一切正常。

為了驗證這個猜想，我們來做個精準的測試：**暫時移除對 `@hr` 這個遠端資料庫的依賴**。如果移除後，應用程式就能成功新增資料，那我們就 100% 鎖定了問題點在於遠端 WMS 資料表的存取權限。

我將為您修改 `src/main/resources/sql/om_extract.sql`。我會同時：
1.  移除 `/*+ DRIVING_SITE(d) */` 這個提示，因為您在 SQL Developer 成功的版本沒有這個。
2.  註解掉與 `zenwms.WMS_SHIPPING@hr` 的關聯。

請您套用以下變更後再試一次。

```sql:src/main/resources/sql/om_extract.sql
// ... existing code ...
insert into ZEN_B2B_JSON_SO_TMP (SEQ_ID,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE) 
select ZEN_B2B_JSON_SEQ.nextval,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE
from (
     SELECT
     'ZEN' as SENDER_CODE,
     'FEILIKS' as RECEIVER_CODE,
      CASE 
        WHEN d.name IS NULL -- ORDER_NO
// ... existing code ...
                 a.INVOICE_DATE,
                 a.CUSTOMER_ID
            FROM apps.ZEN_PACKING_INVOICE_HEADER@zenprod A,
                 apps.ZEN_PACKING_INVOICE_LINE@zenprod B
           WHERE a.invoice_id = b.invoice_id AND b.INVOICE_SOURCE = 'DELIVERY') O--,
         --zenwms.WMS_SHIPPING@hr WS
   WHERE     d.DELIVERY_ID >= 2124472
         AND d.delivery_id = wda.delivery_id
         AND wda.delivery_detail_id = wdd.delivery_detail_id
// ... existing code ...
         AND ship_ps.location_id = ship_loc.location_id
         AND d.DELIVERY_ID = O.DELIVERY_ID
         AND D.name = O.DELIVERY_NAME
         AND mtls.organization_id = d.organization_id    
         --AND O.invoice_no = WS.INVOICENO
         AND zs.FROM_SUBINVENTORY_CODE = '外存倉'
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
// ... existing code ...
```

---

_**User**_

我連線的帳號密碼是一模一樣的

---

_**Assistant**_



---

我了解了，帳號密碼完全一樣，這表示問題不在於「使用者權限」，而在於「連線工作階段 (Session) 環境」的差異。這是一個非常重要的線索。

在我們深入研究複雜的連線設定之前，我想我們可以一起來驗證那個最關鍵的假設：**`NOT EXISTS` 子查詢因為在 `ZEN_B2B_JSON_SO` 表中找到了重複的資料，所以攔截了所有的新增。**

這是最常見、也最有可能的原因。雖然在不同的客戶端（SQL Developer vs. 應用程式）看到不同的結果很奇怪，但如果我們能先排除「資料重複」這個因素，就能更快地找到問題。

請問您目前的環境是測試環境嗎？如果可以的話，我們來做個最直接的測試：**手動清空目標資料表，然後讓應用程式用最原始的 SQL 腳本再跑一次。**

如果您方便操作，請在 SQL Developer 中執行以下指令：

```sql
TRUNCATE TABLE ZEN_B2B_JSON_SO_TMP;
DELETE FROM ZEN_B2B_JSON_SO;
COMMIT;
```

執行完畢後，請您先將 `om_extract.sql` 恢復到最原始的狀態（也就是包含 `/*+ DRIVING_SITE(d) */` 和 `zenwms.WMS_SHIPPING@hr` 的版本），然後直接透過您的應用程式觸發一次資料同步。

我推測的執行結果會是：
1.  因為 `ZEN_B2B_JSON_SO` 已經被清空，`NOT EXISTS` 條件將會通過所有 92 筆資料。
2.  資料會成功 `INSERT` 到 `ZEN_B2B_JSON_SO_TMP`。

如果這個測試成功了，那就證明了我們的猜想：之前的執行失敗，就是因為目標表中已經存在了舊的測試資料。如果還是失敗，那我們就能排除這個可能性，往下一個可能的原因（例如遠端連線的設定）去追查。

這個方法最直接，可以請您試試看嗎？我先將 `om_extract.sql` 恢復原狀。

```sql:src/main/resources/sql/om_extract.sql
begin
EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_LANGUAGE= ''AMERICAN''';
insert into ZEN_B2B_JSON_SO_TMP (SEQ_ID,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE) 
select ZEN_B2B_JSON_SEQ.nextval,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE
from (
     SELECT /*+ DRIVING_SITE(d) */
     'ZEN' as SENDER_CODE,
     'FEILIKS' as RECEIVER_CODE,
      CASE 
        WHEN d.name IS NULL -- ORDER_NO
        OR O.invoice_no IS NULL -- INVOICE_NO
// ... existing code ...
                 a.INVOICE_DATE,
                 a.CUSTOMER_ID
            FROM apps.ZEN_PACKING_INVOICE_HEADER@zenprod A,
                 apps.ZEN_PACKING_INVOICE_LINE@zenprod B
           WHERE a.invoice_id = b.invoice_id AND b.INVOICE_SOURCE = 'DELIVERY') O,
         zenwms.WMS_SHIPPING@hr WS
   WHERE     d.DELIVERY_ID >= 2124472
         AND d.delivery_id = wda.delivery_id
         AND wda.delivery_detail_id = wdd.delivery_detail_id
// ... existing code ...
         AND ship_ps.location_id = ship_loc.location_id
         AND d.DELIVERY_ID = O.DELIVERY_ID
         AND D.name = O.DELIVERY_NAME
         AND mtls.organization_id = d.organization_id    
         AND O.invoice_no = WS.INVOICENO
         AND zs.FROM_SUBINVENTORY_CODE = '外存倉'
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
// ... existing code ...
```

---

_**User**_

還是一樣 只有 @mi_extract.sql 的1筆 跟 @mv_extract.sql 的 4 筆

---

_**Assistant**_



---

好的，感謝您的回覆。這個結果非常關鍵！

`@mi_extract.sql` 和 `@mv_extract.sql` 能夠成功新增資料，而 `@om_extract.sql` 卻不行，這表示：
1.  您的應用程式與資料庫的連線是正常的。
2.  權限和 `NOT EXISTS` 的問題基本上可以排除了。
3.  問題 100% 出在 `om_extract.sql` 這個檔案的 SQL 語法本身，在您的應用程式執行環境下，它的行為和在 SQL Developer 中不同。

我仔細比對了成功的 `mv_extract.sql` 和失敗的 `om_extract.sql`，發現一個決定性的差異，就在於它們如何查詢遠端 WMS 系統 (`@hr` DBLink) 的資料表 `zenwms.WMS_SHIPPING`。

*   **`om_extract.sql` (失敗的)**: 它在主要的 `SELECT` 查詢中，直接 `JOIN` 了 `zenwms.WMS_SHIPPING@hr`。這種寫法要求查詢在執行的一開始，就必須成功地跨資料庫進行關聯。如果這個跨資料庫的 `JOIN` 因為網路、JDBC 驅動程式、或遠端資料庫設定等任何細微的環境問題而失敗，整個查詢就會直接回傳 0 筆資料。

*   **`mv_extract.sql` (成功的)**: 它採用了更穩健的兩步驟作法：
    1.  **先 `INSERT`**: 它先把所有符合條件的資料從 ERP 系統 (`@zenprod`) 查出來，然後 `INSERT` 到暫存表 `ZEN_B2B_JSON_SO_TMP` 中。這一步不牽涉到 `@hr`。
    2.  **再 `DELETE`**: `INSERT` 之後，它才執行一個 `DELETE` 指令，把暫存表中那些在 `zenwms.WMS_SHIPPING@hr` 裡找不到對應發票號碼的資料刪除。

這種「先寫入再刪除」的模式，把複雜的跨資料庫查詢拆開，大大提高了成功率。就算 `DELETE` 那一步因為連線問題失敗了，至少資料也已經進了暫存表，更容易除錯。

我們現在就來修改 `om_extract.sql`，讓它也採用和 `mv_extract.sql` 相同的模式。這應該就能解決問題了。

我將對 `om_extract.sql` 做出以下修改：
1.  從主查詢中移除對 `zenwms.WMS_SHIPPING@hr` 的 `JOIN`。
2.  在腳本結尾，增加一個 `DELETE` 區塊，用來過濾掉 WMS 中不存在的資料。
3.  同時，我會將 `/*+ DRIVING_SITE(d) */` 這個提示保持註解掉的狀態，以符合您在 SQL Developer 中測試成功的版本。

```sql:src/main/resources/sql/om_extract.sql
// ... existing code ...
                 a.INVOICE_DATE,
                 a.CUSTOMER_ID
            FROM apps.ZEN_PACKING_INVOICE_HEADER@zenprod A,
                 apps.ZEN_PACKING_INVOICE_LINE@zenprod B
           WHERE a.invoice_id = b.invoice_id AND b.INVOICE_SOURCE = 'DELIVERY') O
   WHERE     d.DELIVERY_ID >= 2124472
         AND d.delivery_id = wda.delivery_id
         AND wda.delivery_detail_id = wdd.delivery_detail_id
// ... existing code ...
         AND ship_ps.location_id = ship_loc.location_id
         AND d.DELIVERY_ID = O.DELIVERY_ID
         AND D.name = O.DELIVERY_NAME
         AND mtls.organization_id = d.organization_id
         AND zs.FROM_SUBINVENTORY_CODE = '外存倉'
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
         AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC(sysdate) - 1 AND TRUNC(sysdate) + 1 --for正式上線一週後(自動化)
// ... existing code ...
                        OR mil.segment2 IS NULL -- SEGMENT2
                        THEN 'N'
                        ELSE 'W'
                        END) OR STATUS = 'S')
         )
ORDER BY ORDER_NO, ID
);

DELETE FROM ZEN_B2B_JSON_SO_TMP tmp
WHERE NOT EXISTS (
    SELECT 1
    FROM zenwms.WMS_SHIPPING@hr WS
    WHERE WS.INVOICENO = tmp.INVOICE_NO 
) AND tmp.KIND = '撿貨單';

end;
```
請您試試看這個新版本。我認為這次應該可以成功了。

---

_**User**_

還是一樣只有5筆

---

_**Assistant**_



---

好的，感謝您的耐心測試。這確實是一個非常棘手的問題，但我們離真相越來越近了。

您回報說，在套用了「先 INSERT 再 DELETE」的模式後，結果依然相同 (`om_extract.sql` 還是沒有新增資料)，這排除了我之前的猜想，但也給了我們一個更明確的方向。

問題的核心必定在於，`om_extract.sql` 中那段負責 `INSERT` 的 `SELECT` 主查詢，在您的應用程式環境中，因為某種原因，回傳了 0 筆資料。

經過反覆比對成功的 `mv_extract.sql` 和您在 SQL Developer 中成功的測試，我認為我們需要結合兩種策略，這很可能是最終的解決方案：

1.  **恢復 `DRIVING_SITE` 提示**：`om_extract.sql` 的查詢涉及將近 20 個遠端資料表，極其複雜。`/*+ DRIVING_SITE(d) */` 這個提示會**強制**這個複雜的查詢在主要的 ERP 伺服器 (`@zenprod`) 上執行。對於這麼大的分散式查詢，這通常是最高效、最穩定的執行方式。您在 SQL Developer 中不加提示也能成功，可能是因為客戶端工具的連線設定較為寬鬆，但在應用程式的 JDBC 環境下，明確地給予提示可能是必要的。

2.  **維持「先 INSERT 再 DELETE」模式**：我們之前修改的，將 WMS 系統 (`@hr`) 的檢查，從主查詢的 `JOIN` 抽離到後續的 `DELETE` 步驟，這個作法是更穩健的。它將複雜的 ERP 查詢和 WMS 的核對拆開，避免了單一查詢中進行兩次跨資料庫連線的複雜性。

因此，我建議的最終方案是：**在 `om_extract.sql` 中，同時使用 `DRIVING_SITE` 提示來優化主查詢，並維持「先 INSERT 再 DELETE」的模式來處理 WMS 的核對。**

同時，為了確保測試的乾淨，我必須再次強力建議您：**在執行應用程式之前，請務必在 SQL Developer 中手動執行以下指令，確保目標資料表是完全清空的。** 這一步至關重要，可以排除任何舊資料干擾的可能性。

```sql
-- 請在執行應用程式前，先執行這段指令
TRUNCATE TABLE ZEN_B2B_JSON_SO_TMP;
DELETE FROM ZEN_B2B_JSON_SO;
COMMIT;
```

清空資料表後，請套用以下的程式碼修改，然後再執行一次您的應用程式。

我將在 `om_extract.sql` 的 `SELECT` 陳述式中，將 `/*+ DRIVING_SITE(d) */` 提示加回去：

```sql:src/main/resources/sql/om_extract.sql
// ... existing code ...
insert into ZEN_B2B_JSON_SO_TMP (SEQ_ID,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE) 
select ZEN_B2B_JSON_SEQ.nextval,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE
from (
     SELECT /*+ DRIVING_SITE(d) */
     'ZEN' as SENDER_CODE,
     'FEILIKS' as RECEIVER_CODE,
      CASE 
// ... existing code ...
```

這次的修改結合了我們所有的發現，我非常有信心這能解決問題。

---

_**User**_

我剛執行時就有加了

---

_**Assistant**_



---

好的，我了解了情況。您已經將 `om_extract.sql` 的結構修改為「先 INSERT 再 DELETE」，並且恢復了 `/*+ DRIVING_SITE(d) */` 這個提示，但問題依舊存在。這表示我們之前的猜想（`DRIVING_SITE` 和 WMS 的 `JOIN`）雖然合理，但並未命中要害。

這個問題現在非常明確地指向了 `om_extract.sql` 這個檔案本身。既然 `mi_extract.sql` 和 `mv_extract.sql` 可以正常運作，那我們就必須找出 `om_extract.sql` 和它們之間最關鍵的差異。

經過反覆比對，最重要的線索是：**所有成功的腳本 (`mi_extract.sql`, `mv_extract.sql`) 都沒有使用 `/*+ DRIVING_SITE(...) */` 這個提示。**

這個提示會強制查詢在遠端的 `@zenprod` 伺服器上執行。但當查詢在遠端執行時，它內部的 `NOT EXISTS` 子查詢需要反向連回您應用程式所在的本地資料庫來檢查 `ZEN_B2B_JSON_SO` 這張表，這一步很可能因為缺乏反向的 DBLink 設定而失敗，導致整個查詢無聲無息地回傳 0 筆資料。

因此，最正確的修改方向，就是讓 `om_extract.sql` 的結構與成功的 `mv_extract.sql` **完全一致**：
1.  **移除 `DRIVING_SITE` 提示**，讓查詢在本地執行。
2.  **採用「先 INSERT 再 DELETE」的模式**，將對 `@hr` WMS 系統的檢查拆分開。

我理解您之前可能已經嘗試過這個組合但沒有成功。這通常只有兩種可能：
*   查詢語句中，除了我們已經發現的部分外，還隱藏著其他在 JDBC 環境下會導致問題的語法。
*   `NOT EXISTS` 子查詢確實發揮了作用，因為 `ZEN_B2B_JSON_SO` 資料表中存在舊的測試資料，導致所有新資料都被過濾掉了。

為了徹底釐清問題，我將提供兩個版本的 `om_extract.sql` 給您。請您務必在**執行應用程式之前，先手動清空暫存表和目標表** (`TRUNCATE TABLE ZEN_B2B_JSON_SO_TMP;` 和 `DELETE FROM ZEN_B2B_JSON_SO;`)，這一步非常重要！

---

### **方案一：最終正確版本 (建議使用的版本)**

這個版本完全仿照 `mv_extract.sql` 的成功模式。如果執行後依然沒有資料，請直接跳到方案二。

```sql:src/main/resources/sql/om_extract.sql
begin
EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_LANGUAGE= ''AMERICAN''';
insert into ZEN_B2B_JSON_SO_TMP (SEQ_ID,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE) 
select ZEN_B2B_JSON_SEQ.nextval,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE
from (
     SELECT /* DRIVING_SITE hint removed */
     'ZEN' as SENDER_CODE,
     'FEILIKS' as RECEIVER_CODE,
      CASE 
        WHEN d.name IS NULL -- ORDER_NO
        OR O.invoice_no IS NULL -- INVOICE_NO
        OR O.invoice_date IS NULL -- INVOICE_DATE
        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
        OR (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ffvt
           WHERE     rsua.site_use_code = 'SHIP_TO'
                 AND rsua.site_use_id = ship_su.site_use_id
                 AND jrs.salesrep_id = rsua.primary_salesrep_id
                 AND gcc.code_combination_id = jrs.gl_id_rev
                 AND fifs.id_flex_num = gcc.chart_of_accounts_id
                 AND fifs.segment_name = '部門別'
                 AND ffv.flex_value_set_id = fifs.flex_value_set_id
                 AND ffv.flex_value = gcc.segment2
                 AND ffvt.flex_value_id = ffv.flex_value_id
                 AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
        OR party.party_name IS NULL -- CUST_NAME
        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
        OR mtls.segment1
         || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
         || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
        OR (SELECT mcb.segment1
            FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
           WHERE     mic.category_set_id = 1
                 AND mic.category_id = mcb.category_id
                 AND mic.organization_id = mtls.organization_id
                 AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
        OR  DECODE (mtls.segment1,
                 '銷貨折讓', wdd.requested_quantity * -1,
                 wdd.requested_quantity) IS NULL -- QUANTITY
        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
        OR DECODE (mtls.segment1,
                   '銷貨折讓', wdd.requested_quantity * -1,
                   wdd.requested_quantity)
         * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
        OR mtls.attribute1 IS NULL -- ITEM_MODE
        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
        OR mil.segment1 IS NULL -- SEGMENT1 
        OR mil.segment2 IS NULL -- SEGMENT2
        THEN 'N'
        ELSE 'W'
      END as STATUS,
     'OUT' as DIRECTION,
     TO_CHAR(O.invoice_date, 'yyyy-MM-dd HH:mm:ss') as DOC_DATETIME,
     TO_CHAR(sysdate, 'yyyy-MM-dd HH:mm:ss') as LAST_UPDATE_DATE,
     TO_CHAR(sysdate, 'yyyy-MM-dd HH:mm:ss') as CREATION_DATE,
     'admin' as USER_NO,
     O.invoice_no || '-' || l.line_id as ID,
     d.name as ORDER_NO,
     d.ATTRIBUTE5 as INV_SPLIT,
     O.invoice_no as INVOICE_NO,
     TO_CHAR(TRUNC(O.invoice_date), 'yyyy/mm/dd') as INVOICE_DATE,
     TO_CHAR(TO_DATE(d.attribute12, 'DD-MON-YYYY', 'NLS_DATE_LANGUAGE=AMERICAN'), 'yyyy/mm/dd') as EXP_SHIP_DATE,
     cust_acct.account_number as CUST_NO,
      (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ffvt
           WHERE     rsua.site_use_code = 'SHIP_TO'
                 AND rsua.site_use_id = ship_su.site_use_id
                 AND jrs.salesrep_id = rsua.primary_salesrep_id
                 AND gcc.code_combination_id = jrs.gl_id_rev
                 AND fifs.id_flex_num = gcc.chart_of_accounts_id
                 AND fifs.segment_name = '部門別'
                 AND ffv.flex_value_set_id = fifs.flex_value_set_id
                 AND ffv.flex_value = gcc.segment2
                 AND ffvt.flex_value_id = ffv.flex_value_id
                 AND fifs.id_flex_code = 'GL#')
            as DEPT,
      party.party_name as CUST_NAME,
      bill_loc.address1 as INVOICE_ADDRESS,
      ship_ps.party_site_number as SHIP_TO_NO,
      NVL (d.attribute8, ship_loc.address1) as DELIVERY_ADDRESS,
      (SELECT first_name || last_name
            FROM ZEN_RA_CONTACTS_V@zenprod rcs
           WHERE     rcs.customer_id = l.sold_to_org_id
                 AND rcs.address_id = ship_cas.cust_acct_site_id
                 AND rcs.contact_id =
                        (SELECT MIN (contact_id)
                           FROM ZEN_RA_CONTACTS_V@zenprod rcs
                          WHERE     rcs.customer_id = l.sold_to_org_id
                                AND rcs.address_id = ship_cas.cust_acct_site_id
                                AND rcs.status = 'A'))
            as SHIP_TO_CONTACT,
      (SELECT DECODE (a.phone_area_code,
                         NULL, a.phone_number,
                         a.phone_area_code || '-' || a.phone_number)
            FROM zen_ra_phones_v@zenprod a
           WHERE     a.phone_id =
                        (  SELECT MAX (b.phone_id)
                             FROM zen_ra_phones_v@zenprod b
                            WHERE     a.customer_id = b.customer_id
                                  AND a.address_id = b.address_id
                                  AND b.phone_line_type = 'GEN'
                         GROUP BY b.customer_id, b.address_id)
                 AND a.phone_line_type = 'GEN'
                 AND a.customer_id = l.sold_to_org_id
                 AND a.address_id = ship_cas.cust_acct_site_id)
            as SHIP_TO_PHONE,
      mtls.segment1
         || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
         || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL)
            as ZT_PART_NO,
      NVL (l.attribute3, l.attribute5) as CUST_PART_NO,
      l.attribute2 || DECODE (l.attribute1, NULL, NULL, '-' || l.attribute1)
            as CUSTOMER_PO,
      (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute1)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute2)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute3)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute4)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute5)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute6)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute7)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute8)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute9)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute10)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute11)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute14)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute15)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute16)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute17)
         || ' '
         || CASE
               WHEN (NVL (d.ATTRIBUTE6, ship_su.ATTRIBUTE22)) IS NOT NULL
               THEN
                     'Shipping Mark:'
                  || NVL (d.ATTRIBUTE6, ship_su.ATTRIBUTE22)
                  || ' '
               ELSE
                  ' '
            END
         || ship_cas.attribute12
            as SHIP_NOTICE,
      d.attribute4 as SHIP_NOTES,
      DECODE (wdd.RELEASED_STATUS,
                 'B', 'BK',
                 'C', 'SH',
                 'D', 'CL',
                 'R', 'RR',
                 'S', 'RW',
                 'Y', 'SG',
                 'N', 'NR',
                 'X', 'NA')
            as STATUS1,
      (SELECT mcb.segment1
            FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
           WHERE     mic.category_set_id = 1
                 AND mic.category_id = mcb.category_id
                 AND mic.organization_id = mtls.organization_id
                 AND mic.inventory_item_id = mtls.inventory_item_id)
            as BRAND,
      DECODE (mtls.segment1,
                 '銷貨折讓', wdd.requested_quantity * -1,
                 wdd.requested_quantity)
            as QUANTITY,
      TO_CHAR(l.UNIT_SELLING_PRICE,'FM9999999999999990.99999999999999999999') as UNIT_PRICE,
      DECODE (mtls.segment1,
                   '銷貨折讓', wdd.requested_quantity * -1,
                   wdd.requested_quantity)
         * l.UNIT_SELLING_PRICE
            as AMOUNT,
      l.ATTRIBUTE2 as CUST_PO,
      l.attribute6 as CUST_PO2,
      l.ATTRIBUTE1 as CUST_POLINE,
      l.ATTRIBUTE3 as CUST_PN,
      l.ATTRIBUTE5 as CUST_PN2,
      MCI.CUSTOMER_ITEM_DESC as ITEM_DESC,
      mtls.attribute1 as ITEM_MODE,
      l.attribute8 as ORDER_LINE_MEMO,
      TO_CHAR(mtls.UNIT_WEIGHT,'FM9999999999999990.99999999999999999999') as UNIT_WEIGHT,
      mtls.WEIGHT_UOM_CODE as WEIGHT_UOM_CODE,
      zs.FROM_SUBINVENTORY_CODE as FROM_SUBINVENTORY_CODE,
      mil.segment1 as SEGMENT1,
      mil.segment2 as SEGMENT2,
      '撿貨單' as KIND,
      CASE
            WHEN (SELECT msi.attribute9
                    FROM mtl_system_items@zenprod msi
                   WHERE     msi.organization_id = 3
                         AND msi.inventory_item_id = mtls.inventory_item_id)
                    IS NOT NULL
            THEN
               (SELECT msi.attribute9
                  FROM mtl_system_items@zenprod msi
                 WHERE     msi.organization_id = 3
                       AND msi.inventory_item_id = mtls.inventory_item_id)
            ELSE
               mtls.attribute9
         END
            as SUPPLIER_PARTNO,
      MCI.ATTRIBUTE1 as INV_AND_PAC,
      MCI.ATTRIBUTE2 as CUST_PART_NO2,
      h.ATTRIBUTE3 as PO_REMARK,
      '' as RMA_NUMBER,
      '0' as ORD_TYPE,
      'TY' as QC_TYPE 
    FROM apps.wsh_new_deliveries@zenprod d,
         apps.wsh_delivery_assignments@zenprod wda,
         apps.wsh_delivery_details@zenprod wdd,
         apps.mtl_system_items_b@zenprod mtls,
         apps.mtl_item_locations@zenprod mil,
         apps.oe_order_headers_all@zenprod h,
         apps.oe_order_lines_all@zenprod l,
         apps.ZEN_WSH_PICK_SLIP_V@zenprod zs,
         apps.hz_cust_accounts@zenprod cust_acct,
         apps.hz_parties@zenprod party,
         apps.hz_locations@zenprod bill_loc,
         apps.hz_party_sites@zenprod bill_ps,
         apps.hz_cust_acct_sites_all@zenprod bill_cas,
         apps.hz_cust_site_uses_all@zenprod bill_su,
         apps.hz_locations@zenprod ship_loc,
         apps.hz_party_sites@zenprod ship_ps,
         apps.hz_cust_acct_sites_all@zenprod ship_cas,
         apps.hz_cust_site_uses_all@zenprod ship_su,
         apps.MTL_CUSTOMER_ITEMS@zenprod MCI,
         (SELECT a.organization_id,
                 b.DELIVERY_ID,
                 b.DELIVERY_NAME,
                 a.INVOICE_NO,
                 a.INVOICE_DATE,
                 a.CUSTOMER_ID
            FROM apps.ZEN_PACKING_INVOICE_HEADER@zenprod A,
                 apps.ZEN_PACKING_INVOICE_LINE@zenprod B
           WHERE a.invoice_id = b.invoice_id AND b.INVOICE_SOURCE = 'DELIVERY') O
   WHERE     d.DELIVERY_ID >= 2124472
         AND d.delivery_id = wda.delivery_id
         AND wda.delivery_detail_id = wdd.delivery_detail_id
         AND mil.organization_id(+) = zs.organization_id
         AND mil.subinventory_code(+) = zs.FROM_SUBINVENTORY_CODE
         AND mil.inventory_location_id(+) = zs.from_LOCATOR_ID
         AND wdd.inventory_item_id = mtls.inventory_item_id
         AND wdd.source_header_id = h.header_id
         AND wdd.source_line_id = l.line_id
         AND zs.move_order_line_id = wdd.move_order_line_id
         AND zs.ORGANIZATION_ID = wdd.ORGANIZATION_ID
         AND l.sold_to_org_id = MCI.customer_id(+)
         AND l.attribute3 = MCI.customer_item_number(+)
         AND l.sold_to_org_id = cust_acct.cust_account_id
         AND cust_acct.party_id = party.party_id
         AND bill_cas.party_site_id = bill_ps.party_site_id
         AND bill_ps.location_id = bill_loc.location_id
         AND bill_su.cust_acct_site_id = bill_cas.cust_acct_site_id
         AND l.invoice_to_org_id = bill_su.site_use_id
         AND l.ship_to_org_id = ship_su.site_use_id
         AND ship_su.cust_acct_site_id = ship_cas.cust_acct_site_id
         AND ship_cas.party_site_id = ship_ps.party_site_id
         AND ship_ps.location_id = ship_loc.location_id
         AND d.DELIVERY_ID = O.DELIVERY_ID
         AND D.name = O.DELIVERY_NAME
         AND mtls.organization_id = d.organization_id
         AND zs.FROM_SUBINVENTORY_CODE = '外存倉'
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
         AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC(sysdate) - 1 AND TRUNC(sysdate) + 1 --for正式上線一週後(自動化)
         AND NOT EXISTS(
            SELECT 1
            FROM ZEN_B2B_JSON_SO 
            WHERE 
                  ID = O.invoice_no || '-' || l.line_id 
                  AND (STATUS = 
                  (CASE 
                        WHEN d.name IS NULL -- ORDER_NO
                        OR O.invoice_no IS NULL -- INVOICE_NO
                        OR O.invoice_date IS NULL -- INVOICE_DATE
                        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
                        OR (SELECT ffvt.description
                              FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                              jtf_rs_salesreps@zenprod jrs,
                              gl_code_combinations@zenprod gcc,
                              fnd_id_flex_segments@zenprod fifs,
                              fnd_flex_values@zenprod ffv,
                              fnd_flex_values_tl@zenprod ffvt
                        WHERE     rsua.site_use_code = 'SHIP_TO'
                              AND rsua.site_use_id = ship_su.site_use_id
                              AND jrs.salesrep_id = rsua.primary_salesrep_id
                              AND gcc.code_combination_id = jrs.gl_id_rev
                              AND fifs.id_flex_num = gcc.chart_of_accounts_id
                              AND fifs.segment_name = '部門別'
                              AND ffv.flex_value_set_id = fifs.flex_value_set_id
                              AND ffv.flex_value = gcc.segment2
                              AND ffvt.flex_value_id = ffv.flex_value_id
                              AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
                        OR party.party_name IS NULL -- CUST_NAME
                        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
                        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
                        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
                        OR mtls.segment1
                        || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
                        || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
                        OR (SELECT mcb.segment1
                              FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
                        WHERE     mic.category_set_id = 1
                              AND mic.category_id = mcb.category_id
                              AND mic.organization_id = mtls.organization_id
                              AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
                        OR  DECODE (mtls.segment1,
                              '銷貨折讓', wdd.requested_quantity * -1,
                              wdd.requested_quantity) IS NULL -- QUANTITY
                        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
                        OR DECODE (mtls.segment1,
                                    '銷貨折讓', wdd.requested_quantity * -1,
                                    wdd.requested_quantity)
                        * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
                        OR mtls.attribute1 IS NULL -- ITEM_MODE
                        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
                        OR mil.segment1 IS NULL -- SEGMENT1 
                        OR mil.segment2 IS NULL -- SEGMENT2
                        THEN 'N'
                        ELSE 'W'
                        END) OR STATUS = 'S')
         )
ORDER BY ORDER_NO, ID
);

DELETE FROM ZEN_B2B_JSON_SO_TMP tmp
WHERE NOT EXISTS (
    SELECT 1
    FROM zenwms.WMS_SHIPPING@hr WS
    WHERE WS.INVOICENO = tmp.INVOICE_NO 
) AND tmp.KIND = '撿貨單';

end;  
```

---

### **方案二：除錯專用版本 (暫時繞過重複檢查)**

如果方案一失敗，請立刻改用這個版本。這個版本會暫時**跳過 `NOT EXISTS` 重複性檢查**。
*   如果這個版本**成功新增**了 92 筆資料，那問題就 100% 是因為 `ZEN_B2B_JSON_SO` 中有舊資料，導致方案一的查詢被過濾。
*   如果這個版本**依然沒有新增**任何資料，那代表問題出在 `SELECT` 主查詢的某個欄位計算或 `JOIN` 條件上，與 `NOT EXISTS` 無關。

```sql:src/main/resources/sql/om_extract.sql
begin
EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_LANGUAGE= ''AMERICAN''';
insert into ZEN_B2B_JSON_SO_TMP (SEQ_ID,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE) 
select ZEN_B2B_JSON_SEQ.nextval,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE
from (
     SELECT /* DRIVING_SITE hint removed */
     'ZEN' as SENDER_CODE,
     'FEILIKS' as RECEIVER_CODE,
      CASE 
        WHEN d.name IS NULL -- ORDER_NO
        OR O.invoice_no IS NULL -- INVOICE_NO
        OR O.invoice_date IS NULL -- INVOICE_DATE
        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
        OR (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ff

---

_**User**_

@GenericExtractService.java @om_extract.sql 這段沒有成功insert，但在SQL Developer 執行是可以的

---

_**Assistant**_



---

您好，感謝您提供 `GenericExtractService.java` 的程式碼，這非常有幫助。

我詳細分析了您的 Java 程式碼和所有 SQL 腳本，現在問題的癥結點已經非常清楚了。

1.  **程式邏輯正確**：您的 `GenericExtractService` 邏輯是健全的。它會為每一個 SQL 腳本 (`mi_extract.sql`, `mv_extract.sql`, `om_extract.sql` 等) 開啟一個獨立的交易，這表示腳本之間不會互相干擾。
2.  **暫存表已清空**：程式在執行所有腳本之前，會先執行 `DELETE FROM ZEN_B2B_JSON_SO_TMP`。這確保了每次執行都是從一個乾淨的暫存表開始。
3.  **關鍵差異**：您的程式只清空了暫存表 `ZEN_B2B_JSON_SO_TMP`，但是**沒有**清空最終的目標表 `ZEN_B2B_JSON_SO`。

這就是問題的核心所在。請看 `om_extract.sql` 裡面的這一段邏輯：
```sql
--...
AND NOT EXISTS(
   SELECT 1
   FROM ZEN_B2B_JSON_SO  -- <<<<< 檢查的是這張最終的資料表
   WHERE ID = O.invoice_no || '-' || l.line_id 
   --...
)
```
這個 `NOT EXISTS` 條件的作用是：**「在新增資料到暫存表之前，先去 `ZEN_B2B_JSON_SO` 裡面檢查一下，看看這筆單據是否已經存在。如果已經存在，就不要新增。」**

這就完美解釋了您遇到的現象：
*   `mi_extract.sql` 和 `mv_extract.sql` 能夠成功新增 5 筆資料，因為它們處理的是「樣品單」和「調出單」，這些單據可能剛好是新的，在 `ZEN_B2B_JSON_SO` 中不存在。
*   `om_extract.sql` 要處理的是 92 筆「撿貨單」。很可能是因為之前的測試或執行，這 92 筆單據的紀錄已經存在於 `ZEN_B2B_JSON_SO` 表中了。
*   因此，當 `om_extract.sql` 執行時，`NOT EXISTS` 條件對每一筆資料都檢查為「已存在」，所以它正確地過濾了所有 92 筆資料，導致最終新增到暫存表的筆數為 0。
*   您在 SQL Developer 中能查到資料，很可能是因為您執行的是不包含 `NOT EXISTS` 條件的主 `SELECT` 語句，所以看到了原始的 92 筆資料。

**如何驗證並解決**

為了驗證這一點，我們來做一個最直接的測試：我將為您提供一個**除錯版本**的 `om_extract.sql`，這個版本會暫時將 `NOT EXISTS` 的檢查邏輯註解掉。

請您用下面的程式碼替換 `om_extract.sql` 的內容，然後**直接執行您的 Java 應用程式**。

如果這次執行後，您看到了 `om_extract.sql` 成功新增了 92 筆資料，那我們就 100% 確定問題就是出在 `ZEN_B2B_JSON_SO` 中有舊資料。

```sql:src/main/resources/sql/om_extract.sql
begin
EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_LANGUAGE= ''AMERICAN''';
insert into ZEN_B2B_JSON_SO_TMP (SEQ_ID,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE) 
select ZEN_B2B_JSON_SEQ.nextval,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE
from (
     SELECT /* DRIVING_SITE hint removed for local execution */
     'ZEN' as SENDER_CODE,
     'FEILIKS' as RECEIVER_CODE,
      CASE 
        WHEN d.name IS NULL -- ORDER_NO
        OR O.invoice_no IS NULL -- INVOICE_NO
        OR O.invoice_date IS NULL -- INVOICE_DATE
        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
        OR (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ffvt
           WHERE     rsua.site_use_code = 'SHIP_TO'
                 AND rsua.site_use_id = ship_su.site_use_id
                 AND jrs.salesrep_id = rsua.primary_salesrep_id
                 AND gcc.code_combination_id = jrs.gl_id_rev
                 AND fifs.id_flex_num = gcc.chart_of_accounts_id
                 AND fifs.segment_name = '部門別'
                 AND ffv.flex_value_set_id = fifs.flex_value_set_id
                 AND ffv.flex_value = gcc.segment2
                 AND ffvt.flex_value_id = ffv.flex_value_id
                 AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
        OR party.party_name IS NULL -- CUST_NAME
        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
        OR mtls.segment1
         || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
         || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
        OR (SELECT mcb.segment1
            FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
           WHERE     mic.category_set_id = 1
                 AND mic.category_id = mcb.category_id
                 AND mic.organization_id = mtls.organization_id
                 AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
        OR  DECODE (mtls.segment1,
                 '銷貨折讓', wdd.requested_quantity * -1,
                 wdd.requested_quantity) IS NULL -- QUANTITY
        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
        OR DECODE (mtls.segment1,
                   '銷貨折讓', wdd.requested_quantity * -1,
                   wdd.requested_quantity)
         * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
        OR mtls.attribute1 IS NULL -- ITEM_MODE
        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
        OR mil.segment1 IS NULL -- SEGMENT1 
        OR mil.segment2 IS NULL -- SEGMENT2
        THEN 'N'
        ELSE 'W'
      END as STATUS,
     'OUT' as DIRECTION,
     TO_CHAR(O.invoice_date, 'yyyy-MM-dd HH:mm:ss') as DOC_DATETIME,
     TO_CHAR(sysdate, 'yyyy-MM-dd HH:mm:ss') as LAST_UPDATE_DATE,
     TO_CHAR(sysdate, 'yyyy-MM-dd HH:mm:ss') as CREATION_DATE,
     'admin' as USER_NO,
     O.invoice_no || '-' || l.line_id as ID,
     d.name as ORDER_NO,
     d.ATTRIBUTE5 as INV_SPLIT,
     O.invoice_no as INVOICE_NO,
     TO_CHAR(TRUNC(O.invoice_date), 'yyyy/mm/dd') as INVOICE_DATE,
     TO_CHAR(TO_DATE(d.attribute12, 'DD-MON-YYYY', 'NLS_DATE_LANGUAGE=AMERICAN'), 'yyyy/mm/dd') as EXP_SHIP_DATE,
     cust_acct.account_number as CUST_NO,
      (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ffvt
           WHERE     rsua.site_use_code = 'SHIP_TO'
                 AND rsua.site_use_id = ship_su.site_use_id
                 AND jrs.salesrep_id = rsua.primary_salesrep_id
                 AND gcc.code_combination_id = jrs.gl_id_rev
                 AND fifs.id_flex_num = gcc.chart_of_accounts_id
                 AND fifs.segment_name = '部門別'
                 AND ffv.flex_value_set_id = fifs.flex_value_set_id
                 AND ffv.flex_value = gcc.segment2
                 AND ffvt.flex_value_id = ffv.flex_value_id
                 AND fifs.id_flex_code = 'GL#')
            as DEPT,
      party.party_name as CUST_NAME,
      bill_loc.address1 as INVOICE_ADDRESS,
      ship_ps.party_site_number as SHIP_TO_NO,
      NVL (d.attribute8, ship_loc.address1) as DELIVERY_ADDRESS,
      (SELECT first_name || last_name
            FROM ZEN_RA_CONTACTS_V@zenprod rcs
           WHERE     rcs.customer_id = l.sold_to_org_id
                 AND rcs.address_id = ship_cas.cust_acct_site_id
                 AND rcs.contact_id =
                        (SELECT MIN (contact_id)
                           FROM ZEN_RA_CONTACTS_V@zenprod rcs
                          WHERE     rcs.customer_id = l.sold_to_org_id
                                AND rcs.address_id = ship_cas.cust_acct_site_id
                                AND rcs.status = 'A'))
            as SHIP_TO_CONTACT,
      (SELECT DECODE (a.phone_area_code,
                         NULL, a.phone_number,
                         a.phone_area_code || '-' || a.phone_number)
            FROM zen_ra_phones_v@zenprod a
           WHERE     a.phone_id =
                        (  SELECT MAX (b.phone_id)
                             FROM zen_ra_phones_v@zenprod b
                            WHERE     a.customer_id = b.customer_id
                                  AND a.address_id = b.address_id
                                  AND b.phone_line_type = 'GEN'
                         GROUP BY b.customer_id, b.address_id)
                 AND a.phone_line_type = 'GEN'
                 AND a.customer_id = l.sold_to_org_id
                 AND a.address_id = ship_cas.cust_acct_site_id)
            as SHIP_TO_PHONE,
      mtls.segment1
         || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
         || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL)
            as ZT_PART_NO,
      NVL (l.attribute3, l.attribute5) as CUST_PART_NO,
      l.attribute2 || DECODE (l.attribute1, NULL, NULL, '-' || l.attribute1)
            as CUSTOMER_PO,
      (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute1)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute2)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute3)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute4)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute5)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute6)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute7)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute8)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute9)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute10)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute11)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute14)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute15)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute16)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute17)
         || ' '
         || CASE
               WHEN (NVL (d.ATTRIBUTE6, ship_su.ATTRIBUTE22)) IS NOT NULL
               THEN
                     'Shipping Mark:'
                  || NVL (d.ATTRIBUTE6, ship_su.ATTRIBUTE22)
                  || ' '
               ELSE
                  ' '
            END
         || ship_cas.attribute12
            as SHIP_NOTICE,
      d.attribute4 as SHIP_NOTES,
      DECODE (wdd.RELEASED_STATUS,
                 'B', 'BK',
                 'C', 'SH',
                 'D', 'CL',
                 'R', 'RR',
                 'S', 'RW',
                 'Y', 'SG',
                 'N', 'NR',
                 'X', 'NA')
            as STATUS1,
      (SELECT mcb.segment1
            FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
           WHERE     mic.category_set_id = 1
                 AND mic.category_id = mcb.category_id
                 AND mic.organization_id = mtls.organization_id
                 AND mic.inventory_item_id = mtls.inventory_item_id)
            as BRAND,
      DECODE (mtls.segment1,
                 '銷貨折讓', wdd.requested_quantity * -1,
                 wdd.requested_quantity)
            as QUANTITY,
      TO_CHAR(l.UNIT_SELLING_PRICE,'FM9999999999999990.99999999999999999999') as UNIT_PRICE,
      DECODE (mtls.segment1,
                   '銷貨折讓', wdd.requested_quantity * -1,
                   wdd.requested_quantity)
         * l.UNIT_SELLING_PRICE
            as AMOUNT,
      l.ATTRIBUTE2 as CUST_PO,
      l.attribute6 as CUST_PO2,
      l.ATTRIBUTE1 as CUST_POLINE,
      l.ATTRIBUTE3 as CUST_PN,
      l.ATTRIBUTE5 as CUST_PN2,
      MCI.CUSTOMER_ITEM_DESC as ITEM_DESC,
      mtls.attribute1 as ITEM_MODE,
      l.attribute8 as ORDER_LINE_MEMO,
      TO_CHAR(mtls.UNIT_WEIGHT,'FM9999999999999990.99999999999999999999') as UNIT_WEIGHT,
      mtls.WEIGHT_UOM_CODE as WEIGHT_UOM_CODE,
      zs.FROM_SUBINVENTORY_CODE as FROM_SUBINVENTORY_CODE,
      mil.segment1 as SEGMENT1,
      mil.segment2 as SEGMENT2,
      '撿貨單' as KIND,
      CASE
            WHEN (SELECT msi.attribute9
                    FROM mtl_system_items@zenprod msi
                   WHERE     msi.organization_id = 3
                         AND msi.inventory_item_id = mtls.inventory_item_id)
                    IS NOT NULL
            THEN
               (SELECT msi.attribute9
                  FROM mtl_system_items@zenprod msi
                 WHERE     msi.organization_id = 3
                       AND msi.inventory_item_id = mtls.inventory_item_id)
            ELSE
               mtls.attribute9
         END
            as SUPPLIER_PARTNO,
      MCI.ATTRIBUTE1 as INV_AND_PAC,
      MCI.ATTRIBUTE2 as CUST_PART_NO2,
      h.ATTRIBUTE3 as PO_REMARK,
      '' as RMA_NUMBER,
      '0' as ORD_TYPE,
      'TY' as QC_TYPE 
    FROM apps.wsh_new_deliveries@zenprod d,
         apps.wsh_delivery_assignments@zenprod wda,
         apps.wsh_delivery_details@zenprod wdd,
         apps.mtl_system_items_b@zenprod mtls,
         apps.mtl_item_locations@zenprod mil,
         apps.oe_order_headers_all@zenprod h,
         apps.oe_order_lines_all@zenprod l,
         apps.ZEN_WSH_PICK_SLIP_V@zenprod zs,
         apps.hz_cust_accounts@zenprod cust_acct,
         apps.hz_parties@zenprod party,
         apps.hz_locations@zenprod bill_loc,
         apps.hz_party_sites@zenprod bill_ps,
         apps.hz_cust_acct_sites_all@zenprod bill_cas,
         apps.hz_cust_site_uses_all@zenprod bill_su,
         apps.hz_locations@zenprod ship_loc,
         apps.hz_party_sites@zenprod ship_ps,
         apps.hz_cust_acct_sites_all@zenprod ship_cas,
         apps.hz_cust_site_uses_all@zenprod ship_su,
         apps.MTL_CUSTOMER_ITEMS@zenprod MCI,
         (SELECT a.organization_id,
                 b.DELIVERY_ID,
                 b.DELIVERY_NAME,
                 a.INVOICE_NO,
                 a.INVOICE_DATE,
                 a.CUSTOMER_ID
            FROM apps.ZEN_PACKING_INVOICE_HEADER@zenprod A,
                 apps.ZEN_PACKING_INVOICE_LINE@zenprod B
           WHERE a.invoice_id = b.invoice_id AND b.INVOICE_SOURCE = 'DELIVERY') O
   WHERE     d.DELIVERY_ID >= 2124472
         AND d.delivery_id = wda.delivery_id
         AND wda.delivery_detail_id = wdd.delivery_detail_id
         AND mil.organization_id(+) = zs.organization_id
         AND mil.subinventory_code(+) = zs.FROM_SUBINVENTORY_CODE
         AND mil.inventory_location_id(+) = zs.from_LOCATOR_ID
         AND wdd.inventory_item_id = mtls.inventory_item_id
         AND wdd.source_header_id = h.header_id
         AND wdd.source_line_id = l.line_id
         AND zs.move_order_line_id = wdd.move_order_line_id
         AND zs.ORGANIZATION_ID = wdd.ORGANIZATION_ID
         AND l.sold_to_org_id = MCI.customer_id(+)
         AND l.attribute3 = MCI.customer_item_number(+)
         AND l.sold_to_org_id = cust_acct.cust_account_id
         AND cust_acct.party_id = party.party_id
         AND bill_cas.party_site_id = bill_ps.party_site_id
         AND bill_ps.location_id = bill_loc.location_id
         AND bill_su.cust_acct_site_id = bill_cas.cust_acct_site_id
         AND l.invoice_to_org_id = bill_su.site_use_id
         AND l.ship_to_org_id = ship_su.site_use_id
         AND ship_su.cust_acct_site_id = ship_cas.cust_acct_site_id
         AND ship_cas.party_site_id = ship_ps.party_site_id
         AND ship_ps.location_id = ship_loc.location_id
         AND d.DELIVERY_ID = O.DELIVERY_ID
         AND D.name = O.DELIVERY_NAME
         AND mtls.organization_id = d.organization_id
         AND zs.FROM_SUBINVENTORY_CODE = '外存倉'
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
         AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC(sysdate) - 1 AND TRUNC(sysdate) + 1 --for正式上線一週後(自動化)
         /* -- Temporarily disabled for debugging
         AND NOT EXISTS(
            SELECT 1
            FROM ZEN_B2B_JSON_SO 
            WHERE 
                  ID = O.invoice_no || '-' || l.line_id 
                  AND (STATUS = 
                  (CASE 
                        WHEN d.name IS NULL -- ORDER_NO
                        OR O.invoice_no IS NULL -- INVOICE_NO
                        OR O.invoice_date IS NULL -- INVOICE_DATE
                        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
                        OR (SELECT ffvt.description
                              FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                              jtf_rs_salesreps@zenprod jrs,
                              gl_code_combinations@zenprod gcc,
                              fnd_id_flex_segments@zenprod fifs,
                              fnd_flex_values@zenprod ffv,
                              fnd_flex_values_tl@zenprod ffvt
                        WHERE     rsua.site_use_code = 'SHIP_TO'
                              AND rsua.site_use_id = ship_su.site_use_id
                              AND jrs.salesrep_id = rsua.primary_salesrep_id
                              AND gcc.code_combination_id = jrs.gl_id_rev
                              AND fifs.id_flex_num = gcc.chart_of_accounts_id
                              AND fifs.segment_name = '部門別'
                              AND ffv.flex_value_set_id = fifs.flex_value_set_id
                              AND ffv.flex_value = gcc.segment2
                              AND ffvt.flex_value_id = ffv.flex_value_id
                              AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
                        OR party.party_name IS NULL -- CUST_NAME
                        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
                        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
                        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
                        OR mtls.segment1
                        || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
                        || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
                        OR (SELECT mcb.segment1
                              FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
                        WHERE     mic.category_set_id = 1
                              AND mic.category_id = mcb.category_id
                              AND mic.organization_id = mtls.organization_id
                              AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
                        OR  DECODE (mtls.segment1,
                              '銷貨折讓', wdd.requested_quantity * -1,
                              wdd.requested_quantity) IS NULL -- QUANTITY
                        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
                        OR DECODE (mtls.segment1,
                                    '銷貨折讓', wdd.requested_quantity * -1,
                                    wdd.requested_quantity)
                        * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
                        OR mtls.attribute1 IS NULL -- ITEM_MODE
                        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
                        OR mil.segment1 IS NULL -- SEGMENT1 
                        OR mil.segment2 IS NULL -- SEGMENT2
                        THEN 'N'
                        ELSE 'W'
                        END) OR STATUS = 'S')
         )
         */
ORDER BY ORDER_NO, ID
);

DELETE FROM ZEN_B2B_JSON_SO_TMP tmp
WHERE NOT EXISTS (
    SELECT 1
    FROM zenwms.WMS_SHIPPING@hr WS
    WHERE WS.INVOICENO = tmp.INVOICE_NO 
) AND tmp.KIND = '撿貨單';

end;
```

---

_**User**_

現在的 ZEN_B2B_JSON_SO 就是已經空的

---

_**Assistant**_



---

好的，感謝您提供最關鍵的資訊：「現在的 ZEN_B2B_JSON_SO 就是已經空的」。

這條線索極其重要，它推翻了我們先前的假設，並將問題指向一個非常具體的方向。

如果 `ZEN_B2B_JSON_SO` 是空的，那麼 `om_extract.sql` 裡的 `NOT EXISTS` 條件就絕對不是導致資料被過濾的原因。因為 `NOT EXISTS` 只有在 `ZEN_B2B_JSON_SO` 中**找到**對應紀錄時才會攔截，既然是空的，它就不會攔截任何資料。

這表示問題 100% 出在主體的 `SELECT` 查詢本身。儘管這段查詢在 SQL Developer 中可以成功執行，但在您的 Java 應用程式透過 JDBC 連線執行時，因為某種底層的環境差異，導致它查詢失敗，回傳了 0 筆紀錄。

這種「SQL Developer 可以，但 JDBC 不行」的狀況，通常根源於 Oracle 查詢優化器在處理複雜的分散式查詢 (Distributed Query) 時，因為客戶端環境不同而選擇了不同的執行計畫 (Execution Plan)。

**為了徹底釐清這個問題，我們需要進行一次決定性的測試。**

我將提供一個**極簡化**的除錯版本 `om_extract.sql`。這個版本只做一件最單純的事：執行最核心的 `INSERT ... SELECT ...` 語句。
*   我會移除 `NOT EXISTS` 子查詢，讓語法最簡化。
*   我會移除 `DELETE` 區塊，避免對 `@hr` DBLink 的二次操作。
*   我會移除 `DRIVING_SITE` 提示，讓它和您在 SQL Developer 成功的版本完全一致。

請您**務必**用下面的程式碼替換 `om_extract.sql` 的內容，然後再次執行您的 Java 應用程式。

```sql:src/main/resources/sql/om_extract.sql
begin
EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_LANGUAGE= ''AMERICAN''';
insert into ZEN_B2B_JSON_SO_TMP (SEQ_ID,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE) 
select ZEN_B2B_JSON_SEQ.nextval,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE
from (
     SELECT
     'ZEN' as SENDER_CODE,
     'FEILIKS' as RECEIVER_CODE,
      CASE 
        WHEN d.name IS NULL -- ORDER_NO
        OR O.invoice_no IS NULL -- INVOICE_NO
        OR O.invoice_date IS NULL -- INVOICE_DATE
        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
        OR (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ffvt
           WHERE     rsua.site_use_code = 'SHIP_TO'
                 AND rsua.site_use_id = ship_su.site_use_id
                 AND jrs.salesrep_id = rsua.primary_salesrep_id
                 AND gcc.code_combination_id = jrs.gl_id_rev
                 AND fifs.id_flex_num = gcc.chart_of_accounts_id
                 AND fifs.segment_name = '部門別'
                 AND ffv.flex_value_set_id = fifs.flex_value_set_id
                 AND ffv.flex_value = gcc.segment2
                 AND ffvt.flex_value_id = ffv.flex_value_id
                 AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
        OR party.party_name IS NULL -- CUST_NAME
        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
        OR mtls.segment1
         || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
         || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
        OR (SELECT mcb.segment1
            FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
           WHERE     mic.category_set_id = 1
                 AND mic.category_id = mcb.category_id
                 AND mic.organization_id = mtls.organization_id
                 AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
        OR  DECODE (mtls.segment1,
                 '銷貨折讓', wdd.requested_quantity * -1,
                 wdd.requested_quantity) IS NULL -- QUANTITY
        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
        OR DECODE (mtls.segment1,
                   '銷貨折讓', wdd.requested_quantity * -1,
                   wdd.requested_quantity)
         * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
        OR mtls.attribute1 IS NULL -- ITEM_MODE
        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
        OR mil.segment1 IS NULL -- SEGMENT1 
        OR mil.segment2 IS NULL -- SEGMENT2
        THEN 'N'
        ELSE 'W'
      END as STATUS,
     'OUT' as DIRECTION,
     TO_CHAR(O.invoice_date, 'yyyy-MM-dd HH:mm:ss') as DOC_DATETIME,
     TO_CHAR(sysdate, 'yyyy-MM-dd HH:mm:ss') as LAST_UPDATE_DATE,
     TO_CHAR(sysdate, 'yyyy-MM-dd HH:mm:ss') as CREATION_DATE,
     'admin' as USER_NO,
     O.invoice_no || '-' || l.line_id as ID,
     d.name as ORDER_NO,
     d.ATTRIBUTE5 as INV_SPLIT,
     O.invoice_no as INVOICE_NO,
     TO_CHAR(TRUNC(O.invoice_date), 'yyyy/mm/dd') as INVOICE_DATE,
     TO_CHAR(TO_DATE(d.attribute12, 'DD-MON-YYYY', 'NLS_DATE_LANGUAGE=AMERICAN'), 'yyyy/mm/dd') as EXP_SHIP_DATE,
     cust_acct.account_number as CUST_NO,
      (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ffvt
           WHERE     rsua.site_use_code = 'SHIP_TO'
                 AND rsua.site_use_id = ship_su.site_use_id
                 AND jrs.salesrep_id = rsua.primary_salesrep_id
                 AND gcc.code_combination_id = jrs.gl_id_rev
                 AND fifs.id_flex_num = gcc.chart_of_accounts_id
                 AND fifs.segment_name = '部門別'
                 AND ffv.flex_value_set_id = fifs.flex_value_set_id
                 AND ffv.flex_value = gcc.segment2
                 AND ffvt.flex_value_id = ffv.flex_value_id
                 AND fifs.id_flex_code = 'GL#')
            as DEPT,
      party.party_name as CUST_NAME,
      bill_loc.address1 as INVOICE_ADDRESS,
      ship_ps.party_site_number as SHIP_TO_NO,
      NVL (d.attribute8, ship_loc.address1) as DELIVERY_ADDRESS,
      (SELECT first_name || last_name
            FROM ZEN_RA_CONTACTS_V@zenprod rcs
           WHERE     rcs.customer_id = l.sold_to_org_id
                 AND rcs.address_id = ship_cas.cust_acct_site_id
                 AND rcs.contact_id =
                        (SELECT MIN (contact_id)
                           FROM ZEN_RA_CONTACTS_V@zenprod rcs
                          WHERE     rcs.customer_id = l.sold_to_org_id
                                AND rcs.address_id = ship_cas.cust_acct_site_id
                                AND rcs.status = 'A'))
            as SHIP_TO_CONTACT,
      (SELECT DECODE (a.phone_area_code,
                         NULL, a.phone_number,
                         a.phone_area_code || '-' || a.phone_number)
            FROM zen_ra_phones_v@zenprod a
           WHERE     a.phone_id =
                        (  SELECT MAX (b.phone_id)
                             FROM zen_ra_phones_v@zenprod b
                            WHERE     a.customer_id = b.customer_id
                                  AND a.address_id = b.address_id
                                  AND b.phone_line_type = 'GEN'
                         GROUP BY b.customer_id, b.address_id)
                 AND a.phone_line_type = 'GEN'
                 AND a.customer_id = l.sold_to_org_id
                 AND a.address_id = ship_cas.cust_acct_site_id)
            as SHIP_TO_PHONE,
      mtls.segment1
         || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
         || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL)
            as ZT_PART_NO,
      NVL (l.attribute3, l.attribute5) as CUST_PART_NO,
      l.attribute2 || DECODE (l.attribute1, NULL, NULL, '-' || l.attribute1)
            as CUSTOMER_PO,
      (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute1)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute2)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute3)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute4)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute5)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute6)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute7)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute8)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute9)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute10)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute11)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute14)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute15)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute16)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute17)
         || ' '
         || CASE
               WHEN (NVL (d.ATTRIBUTE6, ship_su.ATTRIBUTE22)) IS NOT NULL
               THEN
                     'Shipping Mark:'
                  || NVL (d.ATTRIBUTE6, ship_su.ATTRIBUTE22)
                  || ' '
               ELSE
                  ' '
            END
         || ship_cas.attribute12
            as SHIP_NOTICE,
      d.attribute4 as SHIP_NOTES,
      DECODE (wdd.RELEASED_STATUS,
                 'B', 'BK',
                 'C', 'SH',
                 'D', 'CL',
                 'R', 'RR',
                 'S', 'RW',
                 'Y', 'SG',
                 'N', 'NR',
                 'X', 'NA')
            as STATUS1,
      (SELECT mcb.segment1
            FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
           WHERE     mic.category_set_id = 1
                 AND mic.category_id = mcb.category_id
                 AND mic.organization_id = mtls.organization_id
                 AND mic.inventory_item_id = mtls.inventory_item_id)
            as BRAND,
      DECODE (mtls.segment1,
                 '銷貨折讓', wdd.requested_quantity * -1,
                 wdd.requested_quantity)
            as QUANTITY,
      TO_CHAR(l.UNIT_SELLING_PRICE,'FM9999999999999990.99999999999999999999') as UNIT_PRICE,
      DECODE (mtls.segment1,
                   '銷貨折讓', wdd.requested_quantity * -1,
                   wdd.requested_quantity)
         * l.UNIT_SELLING_PRICE
            as AMOUNT,
      l.ATTRIBUTE2 as CUST_PO,
      l.attribute6 as CUST_PO2,
      l.ATTRIBUTE1 as CUST_POLINE,
      l.ATTRIBUTE3 as CUST_PN,
      l.ATTRIBUTE5 as CUST_PN2,
      MCI.CUSTOMER_ITEM_DESC as ITEM_DESC,
      mtls.attribute1 as ITEM_MODE,
      l.attribute8 as ORDER_LINE_MEMO,
      TO_CHAR(mtls.UNIT_WEIGHT,'FM9999999999999990.99999999999999999999') as UNIT_WEIGHT,
      mtls.WEIGHT_UOM_CODE as WEIGHT_UOM_CODE,
      zs.FROM_SUBINVENTORY_CODE as FROM_SUBINVENTORY_CODE,
      mil.segment1 as SEGMENT1,
      mil.segment2 as SEGMENT2,
      '撿貨單' as KIND,
      CASE
            WHEN (SELECT msi.attribute9
                    FROM mtl_system_items@zenprod msi
                   WHERE     msi.organization_id = 3
                         AND msi.inventory_item_id = mtls.inventory_item_id)
                    IS NOT NULL
            THEN
               (SELECT msi.attribute9
                  FROM mtl_system_items@zenprod msi
                 WHERE     msi.organization_id = 3
                       AND msi.inventory_item_id = mtls.inventory_item_id)
            ELSE
               mtls.attribute9
         END
            as SUPPLIER_PARTNO,
      MCI.ATTRIBUTE1 as INV_AND_PAC,
      MCI.ATTRIBUTE2 as CUST_PART_NO2,
      h.ATTRIBUTE3 as PO_REMARK,
      '' as RMA_NUMBER,
      '0' as ORD_TYPE,
      'TY' as QC_TYPE 
    FROM apps.wsh_new_deliveries@zenprod d,
         apps.wsh_delivery_assignments@zenprod wda,
         apps.wsh_delivery_details@zenprod wdd,
         apps.mtl_system_items_b@zenprod mtls,
         apps.mtl_item_locations@zenprod mil,
         apps.oe_order_headers_all@zenprod h,
         apps.oe_order_lines_all@zenprod l,
         apps.ZEN_WSH_PICK_SLIP_V@zenprod zs,
         apps.hz_cust_accounts@zenprod cust_acct,
         apps.hz_parties@zenprod party,
         apps.hz_locations@zenprod bill_loc,
         apps.hz_party_sites@zenprod bill_ps,
         apps.hz_cust_acct_sites_all@zenprod bill_cas,
         apps.hz_cust_site_uses_all@zenprod bill_su,
         apps.hz_locations@zenprod ship_loc,
         apps.hz_party_sites@zenprod ship_ps,
         apps.hz_cust_acct_sites_all@zenprod ship_cas,
         apps.hz_cust_site_uses_all@zenprod ship_su,
         apps.MTL_CUSTOMER_ITEMS@zenprod MCI,
         (SELECT a.organization_id,
                 b.DELIVERY_ID,
                 b.DELIVERY_NAME,
                 a.INVOICE_NO,
                 a.INVOICE_DATE,
                 a.CUSTOMER_ID
            FROM apps.ZEN_PACKING_INVOICE_HEADER@zenprod A,
                 apps.ZEN_PACKING_INVOICE_LINE@zenprod B
           WHERE a.invoice_id = b.invoice_id AND b.INVOICE_SOURCE = 'DELIVERY') O,
         zenwms.WMS_SHIPPING@hr WS
   WHERE     d.DELIVERY_ID >= 2124472
         AND d.delivery_id = wda.delivery_id
         AND wda.delivery_detail_id = wdd.delivery_detail_id
         AND mil.organization_id(+) = zs.organization_id
         AND mil.subinventory_code(+) = zs.FROM_SUBINVENTORY_CODE
         AND mil.inventory_location_id(+) = zs.from_LOCATOR_ID
         AND wdd.inventory_item_id = mtls.inventory_item_id
         AND wdd.source_header_id = h.header_id
         AND wdd.source_line_id = l.line_id
         AND zs.move_order_line_id = wdd.move_order_line_id
         AND zs.ORGANIZATION_ID = wdd.ORGANIZATION_ID
         AND l.sold_to_org_id = MCI.customer_id(+)
         AND l.attribute3 = MCI.customer_item_number(+)
         AND l.sold_to_org_id = cust_acct.cust_account_id
         AND cust_acct.party_id = party.party_id
         AND bill_cas.party_site_id = bill_ps.party_site_id
         AND bill_ps.location_id = bill_loc.location_id
         AND bill_su.cust_acct_site_id = bill_cas.cust_acct_site_id
         AND l.invoice_to_org_id = bill_su.site_use_id
         AND l.ship_to_org_id = ship_su.site_use_id
         AND ship_su.cust_acct_site_id = ship_cas.cust_acct_site_id
         AND ship_cas.party_site_id = ship_ps.party_site_id
         AND ship_ps.location_id = ship_loc.location_id
         AND d.DELIVERY_ID = O.DELIVERY_ID
         AND D.name = O.DELIVERY_NAME
         AND mtls.organization_id = d.organization_id    
         AND O.invoice_no = WS.INVOICENO
         AND zs.FROM_SUBINVENTORY_CODE = '外存倉'
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
         AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC(sysdate) - 1 AND TRUNC(sysdate) + 1 --for正式上線一週後(自動化)
ORDER BY ORDER_NO, ID
);
end;
```

這次的測試結果將會告訴我們：
*   **如果成功新增了 92 筆資料**：這代表問題就出在 `NOT EXISTS` 或 `DELETE` 這些後續步驟與 JDBC 互動不良。接下來我們就可以把這些步驟加回來，但採用更穩健的 `MERGE` 語句來取代 `INSERT` + `DELETE` 的組合。
*   **如果依然新增 0 筆資料**：這就代表問題藏在 `SELECT` 語句的某個 `JOIN` 或 `WHERE` 條件中，它在 JDBC 環境下會導致查詢失敗。屆時我們就需要逐一簡化 `SELECT` 語句來找出元兇。

這一步是目前最關鍵的除錯步驟，請您務必試一下。

---

_**User**_

還是一樣

---

_**Assistant**_



---

好的，了解了。感謝您的耐心和配合，這個「還是一樣」的結果，反而讓我們排除了所有無關的因素，現在問題的矛頭只有一個。

**結論：問題的根源在於 `om_extract.sql` 這段 SELECT 查詢，在透過 JDBC 執行時，同時存取了兩個不同的遠端資料庫 (`@zenprod` 和 `@hr`)，導致 Oracle 的查詢優化器產生了一個錯誤的執行計畫，最終回傳了 0 筆資料。**

這個現象是分散式查詢 (Distributed Query) 中一個典型且非常棘手的問題。`mi_extract.sql` 之所以成功，是因為它只連到 `@hr`；而 `mv_extract.sql` 之所以成功，是因為它很聰明地把對 `@zenprod` 和 `@hr` 的操作拆成了兩個步驟。

我們要做的，就是把 `mv_extract.sql` 的成功模式，完整地複製到 `om_extract.sql` 上。

我將為您提供最終的、也是我最有信心能成功的版本。這個版本會：
1.  **移除 `DRIVING_SITE` 提示**：因為成功的腳本都沒有使用它。
2.  **第一步 `INSERT`**：只從主要的 ERP 系統 (`@zenprod`) 查詢資料並寫入暫存表，完全不碰 WMS (`@hr`)。
3.  **第二步 `DELETE`**：從暫存表中，刪除掉那些在 WMS (`@hr`) 裡找不到對應發票號碼的紀錄。

這個「先寫入，再過濾」的模式，將複雜的雙重遠端查詢，拆解成兩個單純的遠端查詢，可以有效避免查詢優化器出錯。

請您**務必**使用下面這段最終版本的程式碼，完整替換掉 `src/main/resources/sql/om_extract.sql` 的內容，然後再次執行您的 Java 應用程式。

```sql:src/main/resources/sql/om_extract.sql
begin
EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_LANGUAGE= ''AMERICAN''';

-- 步驟一: 先從主要來源 (@zenprod) 查詢資料並寫入暫存表，完全不關聯 WMS (@hr)
insert into ZEN_B2B_JSON_SO_TMP (SEQ_ID,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE) 
select ZEN_B2B_JSON_SEQ.nextval,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE
from (
     SELECT
     'ZEN' as SENDER_CODE,
     'FEILIKS' as RECEIVER_CODE,
      CASE 
        WHEN d.name IS NULL -- ORDER_NO
        OR O.invoice_no IS NULL -- INVOICE_NO
        OR O.invoice_date IS NULL -- INVOICE_DATE
        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
        OR (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ffvt
           WHERE     rsua.site_use_code = 'SHIP_TO'
                 AND rsua.site_use_id = ship_su.site_use_id
                 AND jrs.salesrep_id = rsua.primary_salesrep_id
                 AND gcc.code_combination_id = jrs.gl_id_rev
                 AND fifs.id_flex_num = gcc.chart_of_accounts_id
                 AND fifs.segment_name = '部門別'
                 AND ffv.flex_value_set_id = fifs.flex_value_set_id
                 AND ffv.flex_value = gcc.segment2
                 AND ffvt.flex_value_id = ffv.flex_value_id
                 AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
        OR party.party_name IS NULL -- CUST_NAME
        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
        OR mtls.segment1
         || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
         || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
        OR (SELECT mcb.segment1
            FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
           WHERE     mic.category_set_id = 1
                 AND mic.category_id = mcb.category_id
                 AND mic.organization_id = mtls.organization_id
                 AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
        OR  DECODE (mtls.segment1,
                 '銷貨折讓', wdd.requested_quantity * -1,
                 wdd.requested_quantity) IS NULL -- QUANTITY
        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
        OR DECODE (mtls.segment1,
                   '銷貨折讓', wdd.requested_quantity * -1,
                   wdd.requested_quantity)
         * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
        OR mtls.attribute1 IS NULL -- ITEM_MODE
        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
        OR mil.segment1 IS NULL -- SEGMENT1 
        OR mil.segment2 IS NULL -- SEGMENT2
        THEN 'N'
        ELSE 'W'
      END as STATUS,
     'OUT' as DIRECTION,
     TO_CHAR(O.invoice_date, 'yyyy-MM-dd HH:mm:ss') as DOC_DATETIME,
     TO_CHAR(sysdate, 'yyyy-MM-dd HH:mm:ss') as LAST_UPDATE_DATE,
     TO_CHAR(sysdate, 'yyyy-MM-dd HH:mm:ss') as CREATION_DATE,
     'admin' as USER_NO,
     O.invoice_no || '-' || l.line_id as ID,
     d.name as ORDER_NO,
     d.ATTRIBUTE5 as INV_SPLIT,
     O.invoice_no as INVOICE_NO,
     TO_CHAR(TRUNC(O.invoice_date), 'yyyy/mm/dd') as INVOICE_DATE,
     TO_CHAR(TO_DATE(d.attribute12, 'DD-MON-YYYY', 'NLS_DATE_LANGUAGE=AMERICAN'), 'yyyy/mm/dd') as EXP_SHIP_DATE,
     cust_acct.account_number as CUST_NO,
      (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ffvt
           WHERE     rsua.site_use_code = 'SHIP_TO'
                 AND rsua.site_use_id = ship_su.site_use_id
                 AND jrs.salesrep_id = rsua.primary_salesrep_id
                 AND gcc.code_combination_id = jrs.gl_id_rev
                 AND fifs.id_flex_num = gcc.chart_of_accounts_id
                 AND fifs.segment_name = '部門別'
                 AND ffv.flex_value_set_id = fifs.flex_value_set_id
                 AND ffv.flex_value = gcc.segment2
                 AND ffvt.flex_value_id = ffv.flex_value_id
                 AND fifs.id_flex_code = 'GL#')
            as DEPT,
      party.party_name as CUST_NAME,
      bill_loc.address1 as INVOICE_ADDRESS,
      ship_ps.party_site_number as SHIP_TO_NO,
      NVL (d.attribute8, ship_loc.address1) as DELIVERY_ADDRESS,
      (SELECT first_name || last_name
            FROM ZEN_RA_CONTACTS_V@zenprod rcs
           WHERE     rcs.customer_id = l.sold_to_org_id
                 AND rcs.address_id = ship_cas.cust_acct_site_id
                 AND rcs.contact_id =
                        (SELECT MIN (contact_id)
                           FROM ZEN_RA_CONTACTS_V@zenprod rcs
                          WHERE     rcs.customer_id = l.sold_to_org_id
                                AND rcs.address_id = ship_cas.cust_acct_site_id
                                AND rcs.status = 'A'))
            as SHIP_TO_CONTACT,
      (SELECT DECODE (a.phone_area_code,
                         NULL, a.phone_number,
                         a.phone_area_code || '-' || a.phone_number)
            FROM zen_ra_phones_v@zenprod a
           WHERE     a.phone_id =
                        (  SELECT MAX (b.phone_id)
                             FROM zen_ra_phones_v@zenprod b
                            WHERE     a.customer_id = b.customer_id
                                  AND a.address_id = b.address_id
                                  AND b.phone_line_type = 'GEN'
                         GROUP BY b.customer_id, b.address_id)
                 AND a.phone_line_type = 'GEN'
                 AND a.customer_id = l.sold_to_org_id
                 AND a.address_id = ship_cas.cust_acct_site_id)
            as SHIP_TO_PHONE,
      mtls.segment1
         || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
         || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL)
            as ZT_PART_NO,
      NVL (l.attribute3, l.attribute5) as CUST_PART_NO,
      l.attribute2 || DECODE (l.attribute1, NULL, NULL, '-' || l.attribute1)
            as CUSTOMER_PO,
      (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute1)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute2)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute3)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute4)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute5)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute6)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute7)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute8)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute9)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute10)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute11)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute14)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute15)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute16)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute17)
         || ' '
         || CASE
               WHEN (NVL (d.ATTRIBUTE6, ship_su.ATTRIBUTE22)) IS NOT NULL
               THEN
                     'Shipping Mark:'
                  || NVL (d.ATTRIBUTE6, ship_su.ATTRIBUTE22)
                  || ' '
               ELSE
                  ' '
            END
         || ship_cas.attribute12
            as SHIP_NOTICE,
      d.attribute4 as SHIP_NOTES,
      DECODE (wdd.RELEASED_STATUS,
                 'B', 'BK',
                 'C', 'SH',
                 'D', 'CL',
                 'R', 'RR',
                 'S', 'RW',
                 'Y', 'SG',
                 'N', 'NR',
                 'X', 'NA')
            as STATUS1,
      (SELECT mcb.segment1
            FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
           WHERE     mic.category_set_id = 1
                 AND mic.category_id = mcb.category_id
                 AND mic.organization_id = mtls.organization_id
                 AND mic.inventory_item_id = mtls.inventory_item_id)
            as BRAND,
      DECODE (mtls.segment1,
                 '銷貨折讓', wdd.requested_quantity * -1,
                 wdd.requested_quantity)
            as QUANTITY,
      TO_CHAR(l.UNIT_SELLING_PRICE,'FM9999999999999990.99999999999999999999') as UNIT_PRICE,
      DECODE (mtls.segment1,
                   '銷貨折讓', wdd.requested_quantity * -1,
                   wdd.requested_quantity)
         * l.UNIT_SELLING_PRICE
            as AMOUNT,
      l.ATTRIBUTE2 as CUST_PO,
      l.attribute6 as CUST_PO2,
      l.ATTRIBUTE1 as CUST_POLINE,
      l.ATTRIBUTE3 as CUST_PN,
      l.ATTRIBUTE5 as CUST_PN2,
      MCI.CUSTOMER_ITEM_DESC as ITEM_DESC,
      mtls.attribute1 as ITEM_MODE,
      l.attribute8 as ORDER_LINE_MEMO,
      TO_CHAR(mtls.UNIT_WEIGHT,'FM9999999999999990.99999999999999999999') as UNIT_WEIGHT,
      mtls.WEIGHT_UOM_CODE as WEIGHT_UOM_CODE,
      zs.FROM_SUBINVENTORY_CODE as FROM_SUBINVENTORY_CODE,
      mil.segment1 as SEGMENT1,
      mil.segment2 as SEGMENT2,
      '撿貨單' as KIND,
      CASE
            WHEN (SELECT msi.attribute9
                    FROM mtl_system_items@zenprod msi
                   WHERE     msi.organization_id = 3
                         AND msi.inventory_item_id = mtls.inventory_item_id)
                    IS NOT NULL
            THEN
               (SELECT msi.attribute9
                  FROM mtl_system_items@zenprod msi
                 WHERE     msi.organization_id = 3
                       AND msi.inventory_item_id = mtls.inventory_item_id)
            ELSE
               mtls.attribute9
         END
            as SUPPLIER_PARTNO,
      MCI.ATTRIBUTE1 as INV_AND_PAC,
      MCI.ATTRIBUTE2 as CUST_PART_NO2,
      h.ATTRIBUTE3 as PO_REMARK,
      '' as RMA_NUMBER,
      '0' as ORD_TYPE,
      'TY' as QC_TYPE 
    FROM apps.wsh_new_deliveries@zenprod d,
         apps.wsh_delivery_assignments@zenprod wda,
         apps.wsh_delivery_details@zenprod wdd,
         apps.mtl_system_items_b@zenprod mtls,
         apps.mtl_item_locations@zenprod mil,
         apps.oe_order_headers_all@zenprod h,
         apps.oe_order_lines_all@zenprod l,
         apps.ZEN_WSH_PICK_SLIP_V@zenprod zs,
         apps.hz_cust_accounts@zenprod cust_acct,
         apps.hz_parties@zenprod party,
         apps.hz_locations@zenprod bill_loc,
         apps.hz_party_sites@zenprod bill_ps,
         apps.hz_cust_acct_sites_all@zenprod bill_cas,
         apps.hz_cust_site_uses_all@zenprod bill_su,
         apps.hz_locations@zenprod ship_loc,
         apps.hz_party_sites@zenprod ship_ps,
         apps.hz_cust_acct_sites_all@zenprod ship_cas,
         apps.hz_cust_site_uses_all@zenprod ship_su,
         apps.MTL_CUSTOMER_ITEMS@zenprod MCI,
         (SELECT a.organization_id,
                 b.DELIVERY_ID,
                 b.DELIVERY_NAME,
                 a.INVOICE_NO,
                 a.INVOICE_DATE,
                 a.CUSTOMER_ID
            FROM apps.ZEN_PACKING_INVOICE_HEADER@zenprod A,
                 apps.ZEN_PACKING_INVOICE_LINE@zenprod B
           WHERE a.invoice_id = b.invoice_id AND b.INVOICE_SOURCE = 'DELIVERY') O
   WHERE     d.DELIVERY_ID >= 2124472
         AND d.delivery_id = wda.delivery_id
         AND wda.delivery_detail_id = wdd.delivery_detail_id
         AND mil.organization_id(+) = zs.organization_id
         AND mil.subinventory_code(+) = zs.FROM_SUBINVENTORY_CODE
         AND mil.inventory_location_id(+) = zs.from_LOCATOR_ID
         AND wdd.inventory_item_id = mtls.inventory_item_id
         AND wdd.source_header_id = h.header_id
         AND wdd.source_line_id = l.line_id
         AND zs.move_order_line_id = wdd.move_order_line_id
         AND zs.ORGANIZATION_ID = wdd.ORGANIZATION_ID
         AND l.sold_to_org_id = MCI.customer_id(+)
         AND l.attribute3 = MCI.customer_item_number(+)
         AND l.sold_to_org_id = cust_acct.cust_account_id
         AND cust_acct.party_id = party.party_id
         AND bill_cas.party_site_id = bill_ps.party_site_id
         AND bill_ps.location_id = bill_loc.location_id
         AND bill_su.cust_acct_site_id = bill_cas.cust_acct_site_id
         AND l.invoice_to_org_id = bill_su.site_use_id
         AND l.ship_to_org_id = ship_su.site_use_id
         AND ship_su.cust_acct_site_id = ship_cas.cust_acct_site_id
         AND ship_cas.party_site_id = ship_ps.party_site_id
         AND ship_ps.location_id = ship_loc.location_id
         AND d.DELIVERY_ID = O.DELIVERY_ID
         AND D.name = O.DELIVERY_NAME
         AND mtls.organization_id = d.organization_id
         AND zs.FROM_SUBINVENTORY_CODE = '外存倉'
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
         AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC(sysdate) - 1 AND TRUNC(sysdate) + 1 --for正式上線一週後(自動化)
         AND NOT EXISTS(
            SELECT 1
            FROM ZEN_B2B_JSON_SO 
            WHERE 
                  ID = O.invoice_no || '-' || l.line_id 
                  AND (STATUS = 
                  (CASE 
                        WHEN d.name IS NULL -- ORDER_NO
                        OR O.invoice_no IS NULL -- INVOICE_NO
                        OR O.invoice_date IS NULL -- INVOICE_DATE
                        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
                        OR (SELECT ffvt.description
                              FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                              jtf_rs_salesreps@zenprod jrs,
                              gl_code_combinations@zenprod gcc,
                              fnd_id_flex_segments@zenprod fifs,
                              fnd_flex_values@zenprod ffv,
                              fnd_flex_values_tl@zenprod ffvt
                        WHERE     rsua.site_use_code = 'SHIP_TO'
                              AND rsua.site_use_id = ship_su.site_use_id
                              AND jrs.salesrep_id = rsua.primary_salesrep_id
                              AND gcc.code_combination_id = jrs.gl_id_rev
                              AND fifs.id_flex_num = gcc.chart_of_accounts_id
                              AND fifs.segment_name = '部門別'
                              AND ffv.flex_value_set_id = fifs.flex_value_set_id
                              AND ffv.flex_value = gcc.segment2
                              AND ffvt.flex_value_id = ffv.flex_value_id
                              AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
                        OR party.party_name IS NULL -- CUST_NAME
                        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
                        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
                        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
                        OR mtls.segment1
                        || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
                        || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
                        OR (SELECT mcb.segment1
                              FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
                        WHERE     mic.category_set_id = 1
                              AND mic.category_id = mcb.category_id
                              AND mic.organization_id = mtls.organization_id
                              AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
                        OR  DECODE (mtls.segment1,
                              '銷貨折讓', wdd.requested_quantity * -1,
                              wdd.requested_quantity) IS NULL -- QUANTITY
                        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
                        OR DECODE (mtls.segment1,
                                    '銷貨折讓', wdd.requested_quantity * -1,
                                    wdd.requested_quantity)
                        * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
                        OR mtls.attribute1 IS NULL -- ITEM_MODE
                        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
                        OR mil.segment1 IS NULL -- SEGMENT1 
                        OR mil.segment2 IS NULL -- SEGMENT2
                        THEN 'N'
                        ELSE 'W'
                        END) OR STATUS = 'S')
         )
ORDER BY ORDER_NO, ID
);

-- 步驟二: 從暫存表中刪除在 WMS (@hr) 中找不到對應發票的紀錄
DELETE FROM ZEN_B2B_JSON_SO_TMP tmp
WHERE NOT EXISTS (
    SELECT 1
    FROM zenwms.WMS_SHIPPING@hr WS
    WHERE WS.INVOICENO = tmp.INVOICE_NO 
) AND tmp.KIND = '撿貨單';

end;
```

如果這個版本**依然失敗**，我會強烈建議您檢查應用程式伺服器上的**日誌 (Log)**，尋找在執行 `om_extract.sql` 這個交易時，由 Oracle JDBC 驅動程式拋出的任何 `ORA-` 錯誤訊息。因為這代表問題已經超出了 SQL 語法邏輯的範疇，而是更底層的連線或環境設定問題。

---

_**User**_

還是失敗

---

_**Assistant**_



---

好的，非常感謝您的測試和回覆。您回報「還是失敗」，這是一個決定性的線索，它讓我們可以排除所有次要因素，直搗問題的核心。

我們現在可以100%確定以下事實：
1.  `ZEN_B2B_JSON_SO` 是空的，所以 `NOT EXISTS` 不是問題。
2.  「先 INSERT 再 DELETE」的模式本身沒錯，但因為第一步的 `INSERT` 就已經拿不到任何資料，所以這個模式也無法成功。
3.  問題的根源，就在於 `om_extract.sql` 的主 `SELECT` 查詢本身。這段查詢在您的 SQL Developer 環境可以成功，但在 Java 應用程式的 JDBC 環境中卻回傳 0 筆資料。

當發生這種情況時，最常見的「隱形殺手」就是**執行環境的日期與時間不一致**。

請看這段 `WHERE` 條件：
`AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC(sysdate) - 1 AND TRUNC(sysdate) + 1`

*   當您在 SQL Developer 執行時，`sysdate` 是您連線的資料庫伺服器的當前日期。
*   當您的 Java 應用程式執行時，`sysdate` **依然是**資料庫伺服器的日期，但是，如果您的應用程式伺服器 (Tomcat, etc.) 和資料庫伺服器設定了**不同的時區 (Timezone)**，這可能會在 JDBC 驅動程式層面造成日期計算的混淆，導致這個 `BETWEEN` 條件永遠為 false。

例如，您的應用程式伺服器可能設定為 UTC 標準時區，而資料庫是本地時區 (UTC+8)，這 8 小時的差異，在午夜前後執行時，就足以讓 `TRUNC(sysdate)` 算出不同的日期。

**為了驗證這個猜想，我們來做個最精準的測試。**

我將提供一個**特別的除錯版本**。這個版本會維持我們之前建立的、最穩健的「先 INSERT 再 DELETE」結構，但會暫時**將日期過濾的條件註解掉**。

請您用下面的程式碼，完整替換 `src/main/resources/sql/om_extract.sql` 的內容，然後再次執行您的應用程式。

```sql:src/main/resources/sql/om_extract.sql
begin
EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_LANGUAGE= ''AMERICAN''';

-- 步驟一: 先從主要來源 (@zenprod) 查詢資料並寫入暫存表，暫時不過濾日期
insert into ZEN_B2B_JSON_SO_TMP (SEQ_ID,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE) 
select ZEN_B2B_JSON_SEQ.nextval,SENDER_CODE,RECEIVER_CODE,STATUS,DIRECTION,DOC_DATETIME,LAST_UPDATE_DATE,CREATION_DATE,USER_NO,ID,ORDER_NO,INV_SPLIT,INVOICE_NO,INVOICE_DATE,EXP_SHIP_DATE,CUST_NO,DEPT,CUST_NAME,INVOICE_ADDRESS,SHIP_TO_NO,DELIVERY_ADDRESS,SHIP_TO_CONTACT,SHIP_TO_PHONE,ZT_PART_NO,CUST_PART_NO,CUSTOMER_PO,SHIP_NOTICE,SHIP_NOTES,STATUS1,BRAND,QUANTITY,UNIT_PRICE,AMOUNT,CUST_PO,CUST_PO2,CUST_POLINE,CUST_PN,CUST_PN2,ITEM_DESC,ITEM_MODE,ORDER_LINE_MEMO,UNIT_WEIGHT,WEIGHT_UOM_CODE,FROM_SUBINVENTORY_CODE,SEGMENT1,SEGMENT2,KIND,SUPPLIER_PARTNO,INV_AND_PAC,CUST_PART_NO2,PO_REMARK,RMA_NUMBER,ORD_TYPE,QC_TYPE
from (
     SELECT
     'ZEN' as SENDER_CODE,
     'FEILIKS' as RECEIVER_CODE,
      CASE 
        WHEN d.name IS NULL -- ORDER_NO
        OR O.invoice_no IS NULL -- INVOICE_NO
        OR O.invoice_date IS NULL -- INVOICE_DATE
        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
        OR (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ffvt
           WHERE     rsua.site_use_code = 'SHIP_TO'
                 AND rsua.site_use_id = ship_su.site_use_id
                 AND jrs.salesrep_id = rsua.primary_salesrep_id
                 AND gcc.code_combination_id = jrs.gl_id_rev
                 AND fifs.id_flex_num = gcc.chart_of_accounts_id
                 AND fifs.segment_name = '部門別'
                 AND ffv.flex_value_set_id = fifs.flex_value_set_id
                 AND ffv.flex_value = gcc.segment2
                 AND ffvt.flex_value_id = ffv.flex_value_id
                 AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
        OR party.party_name IS NULL -- CUST_NAME
        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
        OR mtls.segment1
         || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
         || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
        OR (SELECT mcb.segment1
            FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
           WHERE     mic.category_set_id = 1
                 AND mic.category_id = mcb.category_id
                 AND mic.organization_id = mtls.organization_id
                 AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
        OR  DECODE (mtls.segment1,
                 '銷貨折讓', wdd.requested_quantity * -1,
                 wdd.requested_quantity) IS NULL -- QUANTITY
        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
        OR DECODE (mtls.segment1,
                   '銷貨折讓', wdd.requested_quantity * -1,
                   wdd.requested_quantity)
         * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
        OR mtls.attribute1 IS NULL -- ITEM_MODE
        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
        OR mil.segment1 IS NULL -- SEGMENT1 
        OR mil.segment2 IS NULL -- SEGMENT2
        THEN 'N'
        ELSE 'W'
      END as STATUS,
     'OUT' as DIRECTION,
     TO_CHAR(O.invoice_date, 'yyyy-MM-dd HH:mm:ss') as DOC_DATETIME,
     TO_CHAR(sysdate, 'yyyy-MM-dd HH:mm:ss') as LAST_UPDATE_DATE,
     TO_CHAR(sysdate, 'yyyy-MM-dd HH:mm:ss') as CREATION_DATE,
     'admin' as USER_NO,
     O.invoice_no || '-' || l.line_id as ID,
     d.name as ORDER_NO,
     d.ATTRIBUTE5 as INV_SPLIT,
     O.invoice_no as INVOICE_NO,
     TO_CHAR(TRUNC(O.invoice_date), 'yyyy/mm/dd') as INVOICE_DATE,
     TO_CHAR(TO_DATE(d.attribute12, 'DD-MON-YYYY', 'NLS_DATE_LANGUAGE=AMERICAN'), 'yyyy/mm/dd') as EXP_SHIP_DATE,
     cust_acct.account_number as CUST_NO,
      (SELECT ffvt.description
            FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                 jtf_rs_salesreps@zenprod jrs,
                 gl_code_combinations@zenprod gcc,
                 fnd_id_flex_segments@zenprod fifs,
                 fnd_flex_values@zenprod ffv,
                 fnd_flex_values_tl@zenprod ffvt
           WHERE     rsua.site_use_code = 'SHIP_TO'
                 AND rsua.site_use_id = ship_su.site_use_id
                 AND jrs.salesrep_id = rsua.primary_salesrep_id
                 AND gcc.code_combination_id = jrs.gl_id_rev
                 AND fifs.id_flex_num = gcc.chart_of_accounts_id
                 AND fifs.segment_name = '部門別'
                 AND ffv.flex_value_set_id = fifs.flex_value_set_id
                 AND ffv.flex_value = gcc.segment2
                 AND ffvt.flex_value_id = ffv.flex_value_id
                 AND fifs.id_flex_code = 'GL#')
            as DEPT,
      party.party_name as CUST_NAME,
      bill_loc.address1 as INVOICE_ADDRESS,
      ship_ps.party_site_number as SHIP_TO_NO,
      NVL (d.attribute8, ship_loc.address1) as DELIVERY_ADDRESS,
      (SELECT first_name || last_name
            FROM ZEN_RA_CONTACTS_V@zenprod rcs
           WHERE     rcs.customer_id = l.sold_to_org_id
                 AND rcs.address_id = ship_cas.cust_acct_site_id
                 AND rcs.contact_id =
                        (SELECT MIN (contact_id)
                           FROM ZEN_RA_CONTACTS_V@zenprod rcs
                          WHERE     rcs.customer_id = l.sold_to_org_id
                                AND rcs.address_id = ship_cas.cust_acct_site_id
                                AND rcs.status = 'A'))
            as SHIP_TO_CONTACT,
      (SELECT DECODE (a.phone_area_code,
                         NULL, a.phone_number,
                         a.phone_area_code || '-' || a.phone_number)
            FROM zen_ra_phones_v@zenprod a
           WHERE     a.phone_id =
                        (  SELECT MAX (b.phone_id)
                             FROM zen_ra_phones_v@zenprod b
                            WHERE     a.customer_id = b.customer_id
                                  AND a.address_id = b.address_id
                                  AND b.phone_line_type = 'GEN'
                         GROUP BY b.customer_id, b.address_id)
                 AND a.phone_line_type = 'GEN'
                 AND a.customer_id = l.sold_to_org_id
                 AND a.address_id = ship_cas.cust_acct_site_id)
            as SHIP_TO_PHONE,
      mtls.segment1
         || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
         || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL)
            as ZT_PART_NO,
      NVL (l.attribute3, l.attribute5) as CUST_PART_NO,
      l.attribute2 || DECODE (l.attribute1, NULL, NULL, '-' || l.attribute1)
            as CUSTOMER_PO,
      (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute1)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute2)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute3)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute4)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute5)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute6)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute7)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute8)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute9)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute10)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute11)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute14)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute15)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute16)
         || ' '
         || (SELECT value_description
               FROM zen_fnd_flex_values_v@zenprod
              WHERE     flex_value_set_name = 'ZEN_ADDRESS_ATTRIBUTE'
                    AND flex_value = ship_cas.attribute17)
         || ' '
         || CASE
               WHEN (NVL (d.ATTRIBUTE6, ship_su.ATTRIBUTE22)) IS NOT NULL
               THEN
                     'Shipping Mark:'
                  || NVL (d.ATTRIBUTE6, ship_su.ATTRIBUTE22)
                  || ' '
               ELSE
                  ' '
            END
         || ship_cas.attribute12
            as SHIP_NOTICE,
      d.attribute4 as SHIP_NOTES,
      DECODE (wdd.RELEASED_STATUS,
                 'B', 'BK',
                 'C', 'SH',
                 'D', 'CL',
                 'R', 'RR',
                 'S', 'RW',
                 'Y', 'SG',
                 'N', 'NR',
                 'X', 'NA')
            as STATUS1,
      (SELECT mcb.segment1
            FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
           WHERE     mic.category_set_id = 1
                 AND mic.category_id = mcb.category_id
                 AND mic.organization_id = mtls.organization_id
                 AND mic.inventory_item_id = mtls.inventory_item_id)
            as BRAND,
      DECODE (mtls.segment1,
                 '銷貨折讓', wdd.requested_quantity * -1,
                 wdd.requested_quantity)
            as QUANTITY,
      TO_CHAR(l.UNIT_SELLING_PRICE,'FM9999999999999990.99999999999999999999') as UNIT_PRICE,
      DECODE (mtls.segment1,
                   '銷貨折讓', wdd.requested_quantity * -1,
                   wdd.requested_quantity)
         * l.UNIT_SELLING_PRICE
            as AMOUNT,
      l.ATTRIBUTE2 as CUST_PO,
      l.attribute6 as CUST_PO2,
      l.ATTRIBUTE1 as CUST_POLINE,
      l.ATTRIBUTE3 as CUST_PN,
      l.ATTRIBUTE5 as CUST_PN2,
      MCI.CUSTOMER_ITEM_DESC as ITEM_DESC,
      mtls.attribute1 as ITEM_MODE,
      l.attribute8 as ORDER_LINE_MEMO,
      TO_CHAR(mtls.UNIT_WEIGHT,'FM9999999999999990.99999999999999999999') as UNIT_WEIGHT,
      mtls.WEIGHT_UOM_CODE as WEIGHT_UOM_CODE,
      zs.FROM_SUBINVENTORY_CODE as FROM_SUBINVENTORY_CODE,
      mil.segment1 as SEGMENT1,
      mil.segment2 as SEGMENT2,
      '撿貨單' as KIND,
      CASE
            WHEN (SELECT msi.attribute9
                    FROM mtl_system_items@zenprod msi
                   WHERE     msi.organization_id = 3
                         AND msi.inventory_item_id = mtls.inventory_item_id)
                    IS NOT NULL
            THEN
               (SELECT msi.attribute9
                  FROM mtl_system_items@zenprod msi
                 WHERE     msi.organization_id = 3
                       AND msi.inventory_item_id = mtls.inventory_item_id)
            ELSE
               mtls.attribute9
         END
            as SUPPLIER_PARTNO,
      MCI.ATTRIBUTE1 as INV_AND_PAC,
      MCI.ATTRIBUTE2 as CUST_PART_NO2,
      h.ATTRIBUTE3 as PO_REMARK,
      '' as RMA_NUMBER,
      '0' as ORD_TYPE,
      'TY' as QC_TYPE 
    FROM apps.wsh_new_deliveries@zenprod d,
         apps.wsh_delivery_assignments@zenprod wda,
         apps.wsh_delivery_details@zenprod wdd,
         apps.mtl_system_items_b@zenprod mtls,
         apps.mtl_item_locations@zenprod mil,
         apps.oe_order_headers_all@zenprod h,
         apps.oe_order_lines_all@zenprod l,
         apps.ZEN_WSH_PICK_SLIP_V@zenprod zs,
         apps.hz_cust_accounts@zenprod cust_acct,
         apps.hz_parties@zenprod party,
         apps.hz_locations@zenprod bill_loc,
         apps.hz_party_sites@zenprod bill_ps,
         apps.hz_cust_acct_sites_all@zenprod bill_cas,
         apps.hz_cust_site_uses_all@zenprod bill_su,
         apps.hz_locations@zenprod ship_loc,
         apps.hz_party_sites@zenprod ship_ps,
         apps.hz_cust_acct_sites_all@zenprod ship_cas,
         apps.hz_cust_site_uses_all@zenprod ship_su,
         apps.MTL_CUSTOMER_ITEMS@zenprod MCI,
         (SELECT a.organization_id,
                 b.DELIVERY_ID,
                 b.DELIVERY_NAME,
                 a.INVOICE_NO,
                 a.INVOICE_DATE,
                 a.CUSTOMER_ID
            FROM apps.ZEN_PACKING_INVOICE_HEADER@zenprod A,
                 apps.ZEN_PACKING_INVOICE_LINE@zenprod B
           WHERE a.invoice_id = b.invoice_id AND b.INVOICE_SOURCE = 'DELIVERY') O
   WHERE     d.DELIVERY_ID >= 2124472
         AND d.delivery_id = wda.delivery_id
         AND wda.delivery_detail_id = wdd.delivery_detail_id
         AND mil.organization_id(+) = zs.organization_id
         AND mil.subinventory_code(+) = zs.FROM_SUBINVENTORY_CODE
         AND mil.inventory_location_id(+) = zs.from_LOCATOR_ID
         AND wdd.inventory_item_id = mtls.inventory_item_id
         AND wdd.source_header_id = h.header_id
         AND wdd.source_line_id = l.line_id
         AND zs.move_order_line_id = wdd.move_order_line_id
         AND zs.ORGANIZATION_ID = wdd.ORGANIZATION_ID
         AND l.sold_to_org_id = MCI.customer_id(+)
         AND l.attribute3 = MCI.customer_item_number(+)
         AND l.sold_to_org_id = cust_acct.cust_account_id
         AND cust_acct.party_id = party.party_id
         AND bill_cas.party_site_id = bill_ps.party_site_id
         AND bill_ps.location_id = bill_loc.location_id
         AND bill_su.cust_acct_site_id = bill_cas.cust_acct_site_id
         AND l.invoice_to_org_id = bill_su.site_use_id
         AND l.ship_to_org_id = ship_su.site_use_id
         AND ship_su.cust_acct_site_id = ship_cas.cust_acct_site_id
         AND ship_cas.party_site_id = ship_ps.party_site_id
         AND ship_ps.location_id = ship_loc.location_id
         AND d.DELIVERY_ID = O.DELIVERY_ID
         AND D.name = O.DELIVERY_NAME
         AND mtls.organization_id = d.organization_id
         AND zs.FROM_SUBINVENTORY_CODE = '外存倉'
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
         -- AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC(sysdate) - 1 AND TRUNC(sysdate) + 1 --for正式上線一週後(自動化)
         AND NOT EXISTS(
            SELECT 1
            FROM ZEN_B2B_JSON_SO 
            WHERE 
                  ID = O.invoice_no || '-' || l.line_id 
                  AND (STATUS = 
                  (CASE 
                        WHEN d.name IS NULL -- ORDER_NO
                        OR O.invoice_no IS NULL -- INVOICE_NO
                        OR O.invoice_date IS NULL -- INVOICE_DATE
                        OR d.attribute12 IS NULL -- EXP_SHIP_DATE
                        OR (SELECT ffvt.description
                              FROM HZ_CUST_SITE_USES_ALL@zenprod rsua,
                              jtf_rs_salesreps@zenprod jrs,
                              gl_code_combinations@zenprod gcc,
                              fnd_id_flex_segments@zenprod fifs,
                              fnd_flex_values@zenprod ffv,
                              fnd_flex_values_tl@zenprod ffvt
                        WHERE     rsua.site_use_code = 'SHIP_TO'
                              AND rsua.site_use_id = ship_su.site_use_id
                              AND jrs.salesrep_id = rsua.primary_salesrep_id
                              AND gcc.code_combination_id = jrs.gl_id_rev
                              AND fifs.id_flex_num = gcc.chart_of_accounts_id
                              AND fifs.segment_name = '部門別'
                              AND ffv.flex_value_set_id = fifs.flex_value_set_id
                              AND ffv.flex_value = gcc.segment2
                              AND ffvt.flex_value_id = ffv.flex_value_id
                              AND fifs.id_flex_code = 'GL#') IS NULL -- DEPT
                        OR party.party_name IS NULL -- CUST_NAME
                        OR bill_loc.address1 IS NULL  -- INVOICE_ADDRESS
                        OR ship_ps.party_site_number IS NULL  -- SHIP_TO_NO
                        OR NVL (d.attribute8, ship_loc.address1) IS NULL -- DELIVERY_ADDRESS
                        OR mtls.segment1
                        || DECODE (l.attribute8, NULL, NULL, ' #' || l.attribute8 || '#')
                        || DECODE (mtls.attribute6, 'Y', '(' || mtls.description || ')', NULL) IS NULL -- ZT_PART_NO
                        OR (SELECT mcb.segment1
                              FROM mtl_item_categories@zenprod mic, mtl_categories_b@zenprod mcb
                        WHERE     mic.category_set_id = 1
                              AND mic.category_id = mcb.category_id
                              AND mic.organization_id = mtls.organization_id
                              AND mic.inventory_item_id = mtls.inventory_item_id) IS NULL -- BRAND
                        OR  DECODE (mtls.segment1,
                              '銷貨折讓', wdd.requested_quantity * -1,
                              wdd.requested_quantity) IS NULL -- QUANTITY
                        OR l.UNIT_SELLING_PRICE IS NULL -- UNIT_PRICE
                        OR DECODE (mtls.segment1,
                                    '銷貨折讓', wdd.requested_quantity * -1,
                                    wdd.requested_quantity)
                        * l.UNIT_SELLING_PRICE IS NULL -- AMOUNT
                        OR mtls.attribute1 IS NULL -- ITEM_MODE
                        OR zs.FROM_SUBINVENTORY_CODE IS NULL -- FROM_SUBINVENTORY_CODE
                        OR mil.segment1 IS NULL -- SEGMENT1 
                        OR mil.segment2 IS NULL -- SEGMENT2
                        THEN 'N'
                        ELSE 'W'
                        END) OR STATUS = 'S')
         )
ORDER BY ORDER_NO, ID
);

-- 步驟二: 從暫存表中刪除在 WMS (@hr) 中找不到對應發票的紀錄
DELETE FROM ZEN_B2B_JSON_SO_TMP tmp
WHERE NOT EXISTS (
    SELECT 1
    FROM zenwms.WMS_SHIPPING@hr WS
    WHERE WS.INVOICENO = tmp.INVOICE_NO 
) AND tmp.KIND = '撿貨單';

end;
```

這個測試的結果將會是決定性的：
*   **如果這次成功了**：代表問題就出在 `sysdate` 的時區差異。我們就可以把日期過濾的邏輯加回來，但改用更明確的方式，例如 `(SELECT SYSDATE FROM DUAL@zenprod)` 來確保使用的是遠端資料庫的時間。
*   **如果這次依然失敗**：那就代表問題藏在 `FROM` 或 `WHERE` 的某個 `JOIN` 條件裡，它在 JDBC 環境中產生了錯誤的執行計畫。屆時我們就需要一步步簡化查詢，來找出是哪一個關聯出了問題。

我相信這次測試可以讓我們找到問題的根源。

---

_**User**_

你這樣的改法我怕資料量會太多

---

_**Assistant**_



---

您提的顧慮完全正確，是我考慮不周。直接移除日期過濾條件來進行測試，確實會在正式環境中造成查詢過多的資料，這不是一個好的方法。非常感謝您指出這一點。

我們現在可以將問題縮小到一個範圍：既然 `ZEN_B2B_JSON_SO` 是空的，而且您在 SQL Developer 中執行可以成功，那麼問題幾乎可以肯定是出在**執行環境的差異**上，而其中最可疑的就是**日期的計算方式**。

您在 `om_extract.sql` 中使用的 `TRUNC(sysdate)`，其結果會根據執行指令的伺服器時鐘而定。
*   **在 SQL Developer 中**：`sysdate` 是您連線的資料庫伺服器的時間。
*   **在 Java 應用程式中**：雖然 `sysdate` 仍然是資料庫的時間，但 JDBC 驅動程式在處理日期綁定和時區轉換時，可能會受到應用程式伺服器本身時區設定的影響，從而產生一兩秒甚至數小時的偏差。在午夜跨日的時候，這個微小的偏差就足以讓 `TRUNC(sysdate)` 的結果差了一整天，導致 `BETWEEN` 條件找不到任何資料。

為了解決這個根本問題，同時又**不移除日期過濾**，我建議採用一個更精確、更穩健的寫法：**我們明確地告訴 Oracle，要使用遠端 `@zenprod` 資料庫自己的時鐘來計算日期。**

這樣做可以完全排除任何因為時區或客戶端設定不同所造成的日期計算錯誤。

我將為您修改 `om_extract.sql`，只變更日期計算的部分，保持「先寫入，再過濾」的穩健結構：

```sql:src/main/resources/sql/om_extract.sql
// ... existing code ...
         AND D.name = O.DELIVERY_NAME
         AND mtls.organization_id = d.organization_id
         AND zs.FROM_SUBINVENTORY_CODE = '外存倉'
         AND (mil.segment1 like '%飛力達%' OR mil.segment2 like '%飛力達%')
         --AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') >= TRUNC(sysdate) --for正式上線第一週(手動執行)
         AND TO_DATE(d.attribute12,'DD-MON-YYYY','NLS_DATE_LANGUAGE=AMERICAN') BETWEEN TRUNC((SELECT sysdate FROM DUAL@zenprod)) - 1 AND TRUNC((SELECT sysdate FROM DUAL@zenprod)) + 1 --for正式上線一週後(自動化)
         AND NOT EXISTS(
            SELECT 1
            FROM ZEN_B2B_JSON_SO 
// ... existing code ...
```

這次的修改非常精準：
1.  **保留了日期過濾**，所以不會有效能問題。
2.  將 `TRUNC(sysdate)` 改為 `TRUNC((SELECT sysdate FROM DUAL@zenprod))`，強制使用遠端資料庫的時間，確保了無論在哪裡執行，日期計算的結果都完全一致。

這個方法解決了潛在的環境問題，同時也採納了您的寶貴意見。我相信這應該是最終的解決方案，請您再試一次。

---

_**User**_

結果還是一樣

---

_**Assistant**_



---

好的，我完全理解了。您已經完全按照「先 INSERT 再 DELETE」的穩健模式，並且也使用了精確的遠端日期計算，但結果依然失敗。

非常感謝您的耐心，這個結果極具價值，它讓我們排除了所有外圍因素，現在我們可以 100% 斷定：**問題的根源，就在 `om_extract.sql` 裡面那段極其複雜的 `SELECT` 查詢本身。**

這段查詢在 `FROM` 子句中關聯了將近 20 張位於遠端資料庫 (`@zenprod`) 的資料表。當查詢的複雜度達到這個程度時，Oracle 的查詢優化器在不同的執行環境（SQL Developer vs. JDBC）下，選擇了不同的執行計畫 (Execution Plan)。在您的 JDBC 環境中，它不幸地選擇了一個錯誤的執行計畫，導致查詢結果為 0。

這是一個在處理大型分散式查詢時最棘手、也最隱蔽的問題。既然高層次的策略都已試過，現在我們必須使用最終的除錯手段：「**化繁為簡，逐一擊破**」。

我將為您提供一個**經過大幅簡化的除錯版本 `om_extract.sql`**。這個版本的目標只有一個：**驗證最核心的資料來源是否能在 JDBC 環境下被正確查詢。**

這個版本做了以下調整：
1.  `SELECT` 的欄位減少到只剩下最關鍵的幾個。
2.  `FROM` 子句中，**移除了除了最關鍵的 `wsh_new_deliveries` 和 `ZEN_PACKING_INVOICE` 之外的所有 18 個關聯表**。
3.  `WHERE` 子句中，只保留了這幾個核心表格的關聯條件和日期過濾。

請您用下面這個除錯專用的程式碼，完整替換 `src/main/resources/sql/om_extract.sql` 的內容，然後再次執行您的 Java 應用程式。

```sql:src/main/resources/sql/om_extract.sql
begin
EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_LANGUAGE= ''AMERICAN''';

-- =================================================================
--  除錯專用版本：大幅簡化查詢，只驗證最核心的表格是否能抓取到資料
-- =================================================================
insert into ZEN_B2B_JSON_SO_TMP (
    SEQ_ID, SENDER_CODE, RECEIVER_CODE, ID, ORDER_NO, INVOICE_NO, KIND
) 
select 
    ZEN_B2B_JSON_SEQ.nextval,
    'OM_DEBUG', -- 使用特殊SENDER_CODE以茲識別
    'FEILIKS',
    O.invoice_no || '-' || d.delivery_id, -- 簡化的ID
    d.name, -- ORDER_NO
    O.invoice_no, -- INVOICE_NO
    '撿貨單'
from 
    apps.wsh_new_deliveries@zenprod d,
    (
        SELECT a.organization_id,
               b.DELIVERY_ID,
               b.DELIVERY_NAME,
               a.INVOICE_NO,
               a.INVOICE_DATE
        FROM apps.ZEN_PACKING_INVOICE_HEADER@zenprod A,
             apps.ZEN_PACKING_INVOICE_LINE@zenprod B
        WHERE a.invoice_id = b.invoice_id AND b.INVOICE_SOURCE = 'DELIVERY'
    ) O
WHERE
    d.DELIVERY_ID >= 2124472
    AND d.DELIVERY_ID = O.DELIVERY_ID
    AND D.name = O.DELIVERY_NAME
    AND mtls.organization_id = d.organization_id
    AND TO_DATE(d.attribute12, 'DD-MON-YYYY', 'NLS_DATE_LANGUAGE=AMERICAN') 
        BETWEEN TRUNC((SELECT sysdate FROM DUAL@zenprod)) - 1 
            AND TRUNC((SELECT sysdate FROM DUAL@zenprod)) + 1;

end;
```

這次測試的結果將會給我們最終的答案：
*   **如果這次成功新增了資料**：這就證明問題出在我們剛剛移除的那 18 個關聯表中的某一個或某幾個。接下來我們就可以像拼圖一樣，逐批將它們加回來，直到找到引發問題的那個關聯為止。
*   **如果這次依然新增 0 筆資料**：這代表問題比我們想像的更根本，可能出在這幾個核心表格的關聯，或是您環境中更深層的設定問題。屆時我們需要檢查應用程式伺服器的日誌，尋找 JDBC 驅動程式回報的任何 `ORA-` 錯誤。

我們已經走到最後一步了，我相信這次的測試一定能讓我們找到問題的真相。

---

_**User**_



---

_**Assistant**_



---

太好了！非常感謝您提供這個錯誤日誌，這是一個決定性的突破！

`ORA-00904: "MTLS"."ORGANIZATION_ID": invalid identifier`

這個錯誤訊息非常明確，它直接告訴了我們問題所在。這完全是我的疏忽，非常抱歉。

在我提供給您的**簡化版除錯腳本**中，為了簡化查詢，我從 `FROM` 子句中移除了大量的資料表，其中就包括 `apps.mtl_system_items_b@zenprod mtls` 這張表。但是，我卻疏忽了，沒有把 `WHERE` 子句中跟它相關的條件 `AND mtls.organization_id = d.organization_id` 一併移除。

這導致資料庫在執行時，看到了 `mtls.organization_id`，但因為 `mtls` 這張表已經不在 `FROM` 子句裡了，所以它不認識這個欄位，於是拋出了「無效的識別符」這個錯誤。

現在我們只需要修正這個小錯誤，就可以讓這個簡化的測試繼續進行。我將移除那一行錯誤的條件。

請您用下面這個**更正後的除錯版本**，再次完整替換 `src/main/resources/sql/om_extract.sql` 的內容，然後執行您的 Java 應用程式。

```sql:src/main/resources/sql/om_extract.sql
begin
EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_LANGUAGE= ''AMERICAN''';

-- =================================================================
--  更正後的除錯版本：移除無效的欄位識別符
-- =================================================================
insert into ZEN_B2B_JSON_SO_TMP (
    SEQ_ID, SENDER_CODE, RECEIVER_CODE, ID, ORDER_NO, INVOICE_NO, KIND
) 
select 
    ZEN_B2B_JSON_SEQ.nextval,
    'OM_DEBUG', -- 使用特殊SENDER_CODE以茲識別
    'FEILIKS',
    O.invoice_no || '-' || d.delivery_id, -- 簡化的ID
    d.name, -- ORDER_NO
    O.invoice_no, -- INVOICE_NO
    '撿貨單'
from 
    apps.wsh_new_deliveries@zenprod d,
    (
        SELECT a.organization_id,
               b.DELIVERY_ID,
               b.DELIVERY_NAME,
               a.INVOICE_NO,
               a.INVOICE_DATE
        FROM apps.ZEN_PACKING_INVOICE_HEADER@zenprod A,
             apps.ZEN_PACKING_INVOICE_LINE@zenprod B
        WHERE a.invoice_id = b.invoice_id AND b.INVOICE_SOURCE = 'DELIVERY'
    ) O
WHERE
    d.DELIVERY_ID >= 2124472
    AND d.DELIVERY_ID = O.DELIVERY_ID
    AND D.name = O.DELIVERY_NAME
    -- AND mtls.organization_id = d.organization_id -- 此行已移除，因為 mtls 表不在 FROM 子句中
    AND TO_DATE(d.attribute12, 'DD-MON-YYYY', 'NLS_DATE_LANGUAGE=AMERICAN') 
        BETWEEN TRUNC((SELECT sysdate FROM DUAL@zenprod)) - 1 
            AND TRUNC((SELECT sysdate FROM DUAL@zenprod)) + 1;

end;
```

這個版本修正了語法錯誤。執行後：
*   **如果成功新增資料**：那就證明核心的 `JOIN` 是沒問題的，問題就出在我們之前移除的那些複雜關聯中。
*   **如果依然失敗，但出現了新的 `ORA-` 錯誤**：那也很好，新的錯誤會給我們新的線索。

我們離成功只差一步了，請您再試一次！

---

_**User**_

終於成功了，我後來發現問題點是出在 om_extract.sql 的 編碼是Big5 造成繁體中文字用UTF-8編碼就會亂碼

---

_**Assistant**_



---

